<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../button-action/button-action.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">
<link rel="import" href="../vaadin-date-picker-display/vaadin-date-picker-display.html">

<!--
A Polymer Element showing search fields in a modal dialog.
### Example
```html
<search-fields-dialog
  date-config='{"dateStart": "postingDate", "dateEnd": "postingDate"}'
  search-fields-config="[[searchFieldsConfig]]"
  search-parameters="{{searchParameters}}"
  process-request="{{processRequest}}">
</search-fields-dialog>
```
@demo demo/index.html
-->

<dom-module id="search-fields-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      .green[active],
      .green:hover {
        color: yellowgreen;
      }

      .options-row {
        min-height: 40px;
      }

      .options-label {
        text-align: end;
      }

      .options-row paper-icon-button {
        margin: 1px 5px 3px 15px;
        padding: 5px;
        height: 26px;
        width: 26px;
      }

      .search-labels {
        text-align: end;
        /* Vertically align the search-labels with their paper-input-containers. */
        padding-top: 24px;
      }

      .search-dialog paper-input {
        display: inline-block;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-input-color: var(--dark-primary-color);
        --paper-input-container-focus-color: var(--dark-primary-color);
        --paper-input-container: {
          padding: 2px 5px 2px 20px;
          width: 275px;
        }
        --paper-input-container-input: {
          font-weight: 500;
        }
      }

      .date-labels {
        padding-top: 24px;
        text-align: end;
      }

      vaadin-date-picker-display {
        display: inline-block;
        padding: 2px 5px 2px 20px;
        width: 335px;
        --date-select-bg-color: #ffffff;
        --date-select-text-color: #000000;
      }

      .search-dialog {
        --styled-dialog-min-width: 825px;
        --styled-dialog-max-width: 825px;
      }

      .search-dialog ::content paper-dialog {
        max-width: 900px;
        overflow: auto;
      }

      styled-dialog.search-dialog ::content .inside.styled-dialog .styled-dialog-name {
        max-width: 100px;
        min-width: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      styled-dialog.backdrop ::content paper-dialog {
        opacity: 0.6;
      }

      .toggle-buttons paper-icon-button {
        border-radius: 50%;
        height: 30px;
        width: 30px;
        padding: 5px;
        /* Vertically align the toggle-buttons with their search-labels & paper-input-containers. */
        margin-top: 19px;
      }

      .network-expansion-icon {
        color: lightgray;
      }

      .network-expansion-icon:hover,
      .network-expansion-icon.on {
        color: yellowgreen;
      }

      .network-expansion-icon.on.inactive {
        color: orangered;
      }

      .require-one-icon {
        color: lightgray;
      }

      .require-one-icon:hover,
      .require-one-icon.on {
        color: gold;
      }

      @media all and (min-width: 500px) and (max-width: 650px) {
        .search-options-title {
          width: 80px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }

      @media all and (min-width: 0px) and (max-width: 500px) {
        .search-options-title {
          display: none;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }

      .help-dialog {
        --styled-dialog-min-width: 800px;
        --styled-dialog-max-width: 800px;
      }

      .help-text {
        color: var(--primary-text-color);
        font-size: 16px;
        line-height: 18px;
        min-height: 18px;
      }

      .help-text iron-icon {
        --iron-icon: {
          margin-left: 5px;
          margin-right: 20px;
          min-width: 20px;
        }
        --iron-icon-height: 20px;
        --iron-icon-width: 20px;
      }

      .button-spacer {
        height: 30px;
        width: 30px;
      }

      .network-expansion-info,
      .search-buttons {
        padding-top: 10px;
      }
    </style>

    <paper-button class="layout horizontal center bottom green" active="[[opened]]" on-tap="toggleSearchFieldsDialog" title="Click to Enter Search Terms">
      <iron-icon icon="search" class="bottom" style="margin-right: 5px;"></iron-icon>
      <span class="search-options-title">Click to Enter Search Terms</span>
    </paper-button>

    <styled-dialog
      class$="search-dialog [[_isBackdrop(_helpOpened)]]"
      modal
      opened="{{opened}}"
      on-opened-changed="toggleProcessRequest">

      <template is="dom-repeat" items="[[_searchFields]]" as="dialogConfig">
        <div class="layout horizontal">
          <template is="dom-if" if="[[_equalsDate(dialogConfig.type)]]">
            <div class="styled-dialog-name date-labels">[[dialogConfig.name]]</div>
            <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
              <div class="layout horizontal date-fields-container nowrap">
                <vaadin-date-picker-display
                  facet-key="value"
                  facets="{{searchConfig}}"
                  key="[[searchConfig.key]]"
                  category="[[searchConfig.title]]">
                </vaadin-date-picker-display>
              </div>
            </template>
          </template>

          <template is="dom-if" if="[[!_equalsDate(dialogConfig.type)]]">
            <div class="styled-dialog-name search-labels">[[dialogConfig.name]]</div>
            <div class="layout horizontal wrap">
              <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                <div class="layout horizontal nowrap">
                  <paper-input
                    id$="input_[[searchConfig.key]]"
                    label="[[searchConfig.title]]"
                    value="{{searchConfig.value}}"
                    on-keyup="_checkSearchFieldInputKey">
                  </paper-input>
                  <div class="layout horizontal toggle-buttons">
                    <paper-icon-button
                      class$="require-one-icon [[_getButtonStyleClass(searchConfig.requireOne)]]"
                      icon="fa:star"
                      title="Click to Require at Least One Term from [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.requireOne)]])"
                      on-tap="_toggleRequireOne">
                    </paper-icon-button>
                    <template is="dom-if" if="[[searchConfig.enableNetworkExpansion]]">
                      <paper-icon-button
                        class$="network-expansion-icon [[_getNetworkExpansionStyleClass(searchConfig.networkExpansionOn, _isNetworkExpansionActive)]]"
                        icon="fa:arrows-alt"
                        title="Click to Toggle Network Expansion of [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.networkExpansionOn)]])"
                        on-tap="_toggleNetworkExpansion">
                      </paper-icon-button>
                    </template>
                    <template is="dom-if" if="[[!searchConfig.enableNetworkExpansion]]">
                      <div class="button-spacer"></div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </template>
        </div>
      </template>

      <div class="layout horizontal center-justified search-buttons">
        <button-action class="styled-dialog-button" icon="fa:search" text="Search" on-tap="handleSearch"></button-action>
        <button-action class="styled-dialog-button" icon="fa:undo" text="Reset" on-tap="resetAllSearchFields"></button-action>
        <button-action class="styled-dialog-button" icon="fa:times" text="Cancel" on-tap="cancelSearch"></button-action>
        <button-action class="styled-dialog-button" icon="fa:question" text="Help" on-tap="openHelp"></button-action>
      </div>
    </styled-dialog>

    <styled-dialog class="help-dialog" header="Search Help" opened="{{_helpOpened}}">
      <div class="help-text">
        Enter words or phrases as <strong>search terms</strong> in one or more text fields.
        Use <strong>commas</strong> to separate search terms.
      </div>
      <div class="help-text">
        A phrase of multiple words (without commas) is treated as a <strong>single</strong> search term (no quotation marks needed).
      </div>
      <div class="help-text">
        Use a <strong>plus sign</strong> (<strong>+</strong>) to mark a <strong>required</strong> search term and a
        <strong>minus sign</strong> (<strong>-</strong>) to mark an <strong>excluded</strong> search term.
      </div>
      <div class="help-text">
        Click the <strong>SEARCH</strong> button or press the <strong>ENTER</strong> key to run the search.
        Click the <strong>RESET</strong> button to clear all terms.
      </div>
      <div class="help-text">
        Example:  <strong>+New York, New Jersey, -New Hampshire</strong>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="require-one-icon on" icon="fa:star"></iron-icon>
        <div>
          Click the <strong>star</strong> button to <strong>require at least one term from a field</strong> to match every search result.
          (Terms may still be marked as excluded.)
          This is helpful if you want results that match one term but you don't need results that match all terms simultaneously.
          Example:  <strong>New York, Bronx, Brooklyn, Manhattan, Queens</strong>
        </div>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="network-expansion-icon on" icon="fa:arrows-alt"></iron-icon>
        <div class="layout vertical">
          <div>
            Click the <strong>expand</strong> button to activate <strong>network expansion</strong> on a field and run a <strong>multi-stage search</strong>:
            first, DIG finds results that match the search terms like normal;
            next, DIG finds results that match the terms in the network expansion fields from the results of the first search;
            then, DIG shows the combined results.
          </div>
          <div style="margin-top: 10px;">
            Network expansion will only work if one or more network expansion fields have one or more search terms.
            Please note that it may take a minute or more to run a search with network expansion activated.
          </div>
        </div>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _ */
    'use strict';

    Polymer({
      is: 'search-fields-dialog',

      properties: {
        /**
         * (Optional)
         *
         * The keys of dates in the searchFieldsConfig mapped to the keys of dates in the searchParameters.
         *
         * @type {Object}
         * @default {}
         */
        dateConfig: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * (Optional|Output)
         *
         * Whether the dialog is opened.
         *
         * @type {Boolean}
         * @default false
         */
        opened: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Optional|Output)
         *
         * Whether to let queries run.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },

        /**
         * (Optional|Output)
         *
         * Whether the user canceled the changes.
         *
         * @type {Boolean}
         * @default false
         */
        userCanceled: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Optional)
         *
         * The data property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'data'
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * (Optional)
         *
         * The key property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'key'
         */
        dataKeyProperty: {
          type: String,
          value: 'key'
        },

        /**
         * (Optional)
         *
         * The title property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'title'
         */
        dataTitleProperty: {
          type: String,
          value: 'title'
        },

        /**
         * (Optional)
         *
         * The name property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'name'
         */
        nameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * (Optional)
         *
         * The type property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'type'
         */
        typeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * (Optional|Output)
         *
         * The network expansion parameters passed in.
         *
         * @type {Object}
         */
        networkExpansionParameters: {
          type: Object,
          notify: true
        },

        /**
         * (Required|Output)
         *
         * A list of objects that correspond to groupings of search fields.
         *
         * @type {Array}
         */
        searchFieldsConfig: {
          type: Array
        },

        /**
         * (Optional)
         *
         * A function that returns whether all the search parameters in the given object are disabled (or empty).
         *
         * @type {Object}
         * @default function
         */
        areSearchParametersDisabled: {
          type: Object,
          value: function() {
            return function(searchParameters) {
              return _.keys(searchParameters).every(function(type) {
                if(_.isEmpty(searchParameters[type])) {
                  return true;
                }
                return _.keys(searchParameters[type]).every(function(term) {
                  return !searchParameters[type][term].enabled;
                });
              });
            };
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms search parameter data into a search parameter object.
         *
         * @type {Object}
         * @default function(category, enabled, key, text, search, date) { return { category: category, date: date, enabled: enabled, key: key, search: search, text: text }; }
         */
        buildSearchParameter: {
          type: Object,
          value: function() {
            return function(category, enabled, key, text, search, date) {
              return {
                category: category,
                date: date,
                enabled: enabled,
                key: key,
                search: search,
                text: text
              };
            };
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms a search parameter object into an object with "enabled", "search", and "text" properties.
         *
         * @type {Object}
         * @default function(searchParameter) { return { enabled: searchParameter.enabled, search: searchParameter.search, text: searchParameter.text }; }
         */
        getSearchParameterData: {
          type: Object,
          value: function() {
            return function(searchParameter) {
              return {
                enabled: searchParameter.enabled,
                search: searchParameter.search,
                text: searchParameter.text
              };
            };
          }
        },

        /**
         * (Required|Output)
         *
         * The search parameters created from the terms entered into the dialog.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * Whether the help dialog is opened.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _helpOpened: {
          type: Boolean,
          value: false
        },

        /**
         * Whether network expansion is active based on the fields and values.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _isNetworkExpansionActive: {
          type: Boolean,
          value: false
        },

        /**
         * The search fields shown in the dialog.
         *
         * @type {Array}
         * @private
         */
        _searchFields: {
          computed: '_createSearchFields(searchFieldsConfig, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty)',
          type: Array
        }
      },

      observers: [
        'toggleProcessRequest(searchParameters.*)'
      ],

      /**
       * Toggles whether to let queries run whenever the search parameters change or the dialog is opened or closed.
       */
      toggleProcessRequest: function() {
        this.processRequest = !this.opened && !this.userCanceled;
        // reset user canceled variable
        this.userCanceled = false;
      },

      /**
       * Updates the search fields shown in the dialog from the search parameters if opening the dialog, then opens or closes the dialog.
       */
      toggleSearchFieldsDialog: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        // Set or clear the search fields whenever the dialog is opened.
        if(!this.opened && this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self._updateDateFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex, 'value']);
                } else {
                  self._updateSearchFieldFromParameter(searchConfig);
                }
              });
            }
          });
        }

        this.opened = !this.opened;
      },

      /**
       * Creates and returns the search fields shown in the dialog.
       *
       * @param {Array} config
       * @param {String} dataProperty
       * @param {String} nameProperty
       * @param {String} typeProperty
       * @param {String} dataKeyProperty
       * @param {String} dataTitleProperty
       * @return {Array}
       * @private
       */
      _createSearchFields: function(config, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty) {
        var dateKeys = _.keys(this.dateConfig);
        return config.map(function(dialogConfig) {
          return {
            data: dialogConfig[dataProperty].map(function(searchConfig) {
              var isDate = (dateKeys.indexOf(searchConfig[dataKeyProperty]) >= 0);
              return {
                key: searchConfig[dataKeyProperty],
                title: searchConfig[dataTitleProperty],
                value: isDate ? {} : '',
                enableNetworkExpansion: isDate ? undefined : (searchConfig.enableNetworkExpansion || false),
                networkExpansionOn: isDate ? undefined : false,
                requireOne: isDate ? undefined : true
              };
            }),
            name: dialogConfig[nameProperty],
            type: dialogConfig[typeProperty]
          };
        });
      },

      /**
       * Returns whether the given argument is 'date'.
       *
       * @param {String} string
       * @return {Boolean}
       * @private
       */
      _equalsDate: function(string) {
        return string === 'date';
      },

      /**
       * Returns the style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonStyleClass: function(on) {
        return on ? 'on' : '';
      },

      /**
       * Returns the text for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonText: function(on) {
        return on ? 'On' : 'Off';
      },

      /**
       * Returns the checkbox icon with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getCheckboxIcon: function(on) {
        return on ? 'fa:check-square' : 'fa:square-o';
      },

      /**
       * Returns the network expansion style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @param {Boolean} active
       * @return {String}
       * @private
       */
      _getNetworkExpansionStyleClass: function(on, active) {
        return this._getButtonStyleClass(on) + (active ? '' : ' inactive');
      },

      /**
       * Returns the backdrop style class.
       *
       * @param {Boolean} helpOpened
       * @return {String}
       * @private
       */
      _isBackdrop: function(helpOpened) {
        return helpOpened ? 'backdrop' : '';
      },

      /**
       * Toggles the networkExpansionOn property of the searchConfig in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleNetworkExpansion: function(event) {
        event.model.set('searchConfig.networkExpansionOn', !event.model.searchConfig.networkExpansionOn);
        this._updateNetworkExpansion();
      },

      /**
       * Toggles the requireOne property of the searchConfig in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleRequireOne: function(event) {
        event.model.set('searchConfig.requireOne', !event.model.searchConfig.requireOne);
      },

      /**
       * Returns a string of unformatted phones separated by newlines.
       *
       * @param {String} phone
       * @return {String}
       * @private
       */
      _unformatPhones: function(phone) {
        // Replace all delimiters (whitespace, commas, and, semicolons) with single spaces.
        return phone.replace(/[\s,;]/g, ' ')
          // Remove all non-digit, non-whitespace characters.
          .replace(/[^\d\s]/g, '')
          // Remove extra spaces.
          .replace(/\s+/g, '\n')
          .trim();
      },

      /**
       * Updates the searchParameters with a new object and notifies observers.
       *
       * @param {String} type
       * @param {String} term
       * @param {String} title
       * @param {Boolean} enabled
       * @private
       */
      _updateSearchParameterAndNotify: function(type, term, name, enabled, search) {
        this.searchParameters[type][term] = this.buildSearchParameter(name, enabled, term, term, search);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', type, '*'], this.buildSearchParameter(name, enabled, term, term, search));
      },

      /**
       * Updates the searchParameters and networkExpansionParameters from the given config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchAndNetworkParameterFromField: function(searchConfig) {
        var self = this;

        var terms = searchConfig.value.split(',').map(function(term) {
          return term.trim();
        }).reduce(function(terms, term) {
          var search = searchConfig.requireOne ? 'union' : 'optional';
          var key = term;

          // An excluded term overrides searchConfig.requireOne.
          if(key.indexOf('-') === 0) {
            search = 'excluded';
            key = key.substring(1);
          }

          if(key.indexOf('+') === 0) {
            search = (search === 'union' ? 'union' : 'required');
            key = key.substring(1);
          }

          // TODO Move custom formatting.
          if(searchConfig.key === 'phone') {
            key = self._unformatPhones(key);
          }

          if(key) {
            terms[key] = search;
          }

          return terms;
        }, {});

        _.keys(self.searchParameters[searchConfig.key]).forEach(function(term) {
          // Disable deleted terms.
          if(self.searchParameters[searchConfig.key][term].enabled && _.keys(terms).indexOf(term) < 0) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, false);
          }
        });

        _.keys(terms).forEach(function(term) {
          // Add new terms.
          if(term) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, true, terms[term]);
          }
        });

        // TODO: network expansion -- do we need notify?
        if(self._isNetworkExpansionActive && self.networkExpansionParameters[searchConfig.key] !== undefined &&
            self.networkExpansionParameters[searchConfig.key] !== searchConfig.networkExpansionOn) {
          self.networkExpansionParameters[searchConfig.key] = searchConfig.networkExpansionOn;
          self.notifyPath(['networkExpansionParameters', searchConfig.key], searchConfig.networkExpansionOn);
        }
      },

      /**
       * Updates the searchParameters with a new date object and notifies observers.
       *
       * @param {String} key
       * @param {Object} date
       * @param {String} text
       * @param {String} category
       * @param {Boolean} enabled
       * @private
       */
      _updateDateParameterAndNotify: function(key, date, text, category, enabled) {
        var parameterKey = this.dateConfig[key];

        this.searchParameters[parameterKey][key] = this.buildSearchParameter(category, enabled, key, text, 'required', date);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', parameterKey, key], this.buildSearchParameter(category, enabled, key, text, 'required', date));
      },

      /**
       * Updates the searchParameters from the given date config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateDateParameterFromField: function(searchConfig) {

        var parameterKey = this.dateConfig[searchConfig.key];
        // TODO Don't assume data structure.
        if(!_.isEmpty(searchConfig.value[searchConfig.key])) {
          var dateObject = searchConfig.value[searchConfig.key];
          this._updateDateParameterAndNotify(dateObject.key, dateObject.date, dateObject.text, dateObject.category, dateObject.enabled);
        } else if(this.searchParameters[parameterKey][searchConfig.key]) {
          this.searchParameters[parameterKey][searchConfig.key] = {};
          this.notifyPath(['searchParameters', parameterKey, searchConfig.key], {});
        }
      },

      /**
       * Updates the searchParameters from the search fields in the dialog by adding or removing search terms.
       *
       * @private
       */
      _updateSearchParametersFromFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self._updateDateParameterFromField(searchConfig);
                } else {
                  self._updateSearchAndNetworkParameterFromField(searchConfig);
                }
              });
            }
          });
        }
      },

      /**
       * Updates the search field input of the given config object from the searchParameters.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchFieldFromParameter: function(searchConfig) {
        var self = this;
        var termData = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).enabled;
        }).map(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]);
        });
        searchConfig.value = termData.map(function(data) {
          var prefix = (data.search === 'required' ? '+' : (data.search === 'excluded' ? '-' : ''));
          return prefix + data.text;
        }).join(', ');
        searchConfig.requireOne = !termData.length ? true : termData.some(function(data) {
          return data.search === 'union';
        });

        this.$$('#input_' + searchConfig.key).value = searchConfig.value;
      },

      /**
       * Updates the date input of the given config object from the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateDateFieldFromParameter: function(searchConfig, updatePath) {
        var parameterKey = this.dateConfig[searchConfig.key];
        searchConfig.value = {};
        if(this.searchParameters[parameterKey][searchConfig.key]) {
          searchConfig.value[searchConfig.key] = this.searchParameters[parameterKey][searchConfig.key];
        }
        this.set(updatePath, searchConfig.value);
      },

      /**
       * Updates whether network expansion is active based on the active network expansion fields and values in network expansion fields.
       *
       * @private
       */
      _updateNetworkExpansion: function() {
        // Find all fields for which network expansion is active.
        var fields = this._searchFields.reduce(function(fields, dialogConfig) {
          return fields.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.networkExpansionOn;
          }).map(function(searchConfig) {
            return searchConfig.title;
          }));
        }, []);

        // Find all values (search terms) in fields with the network expansion option.
        var values = this._searchFields.reduce(function(values, dialogConfig) {
          return values.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.enableNetworkExpansion && !!(searchConfig.value.trim());
          }).map(function(searchConfig) {
            return searchConfig.value.trim();
          }));
        }, []).reduce(function(values, value) {
          // Split values into individual search terms.
          return values.concat(value.split(',').map(function(term) {
            return term.trim();
          }).filter(function(term) {
            return term && term !== '+' && term !== '-';
          }));
        }, []);

        this._isNetworkExpansionActive = (fields.length && values.length);
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog so that new queries can run.
       */
      handleSearch: function() {
        this._updateSearchParametersFromFields();

        if(this.areSearchParametersDisabled(this.searchParameters)) {
          this.resetAllSearchFields();
          return;
        }

        this.toggleSearchFieldsDialog();
      },

      /**
       * Clears all of the search fields in the dialog.
       */
      resetAllSearchFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'value'], {});
                } else {
                  self.$$('#input_' + searchConfig.key).value = '';
                }
              });
            }
          });
        }
      },

      /**
       * Cancels the changes to the search fields and closes the dialog.
       */
      cancelSearch: function() {
        this.userCanceled = true;
        this.toggleSearchFieldsDialog();
      },

      /**
       * Opens the help dialog.
       */
      openHelp: function() {
        this.set('_helpOpened', true);
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _checkSearchFieldInputKey: function(event) {
        this._updateNetworkExpansion();
        if(event.keyCode === 13) {
          this.handleSearch();
        }
      }
    });
  })();
  </script>
</dom-module>
