<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../button-action/button-action.html">
<link rel="import" href="../date-picker-display/date-picker-display.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../filter-behavior/filter-behavior.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../phone-behavior/phone-behavior.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">

<!--
A Polymer Element showing search fields in a modal dialog.
### Example
```html
<search-fields-dialog
  date-config='{"dateStart": "postingDate", "dateEnd": "postingDate"}'
  search-fields-config="[[searchFieldsConfig]]"
  search-parameters="{{searchParameters}}"
  process-request="{{processRequest}}">
</search-fields-dialog>
```
@demo demo/index.html
-->

<dom-module id="search-fields-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }

      .green[active],
      .green:hover {
        color: yellowgreen;
      }

      .search-labels {
        line-height: 25px;
        padding-top: 20px;
        text-align: end;
      }

      .search-dialog paper-input {
        display: inline-block;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-input-color: var(--dark-primary-color);
        --paper-input-container-focus-color: var(--dark-primary-color);
        --paper-input-container: {
          padding: 0 10px 4px;
          width: 215px;
        }
        --paper-input-container-input: {
          font-weight: 500;
        }
      }

      .date-fields-title {
        padding-top: 15px;
      }

      .date-fields-container > date-picker-display {
        display: inline-block;
        margin: 0 10px;
        padding: 5px 30px 9px 0px;
        width: 215px;
        --date-select-bg-color: #ffffff;
        --date-select-text-color: #000000;
      }

      .search-dialog .search-buttons {
        padding-top: 5px;
      }

      styled-dialog ::content .inside.styled-dialog .styled-dialog-name {
        min-width: 80px;
      }

      .toggle-buttons paper-icon-button {
        border-radius: 5px;
        margin-bottom: 10px;
        margin-right: 10px;
        margin-top: 20px;
        padding: 0;
        height: 20px;
        width: 20px;
      }

      .net-exp {
        color: black;
      }

      .net-exp.active {
        color: yellowgreen;
      }

      @media all and (min-width: 500px) and (max-width: 650px) {
        .search-options-title {
          width: 80px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }

      @media all and (min-width: 0px) and (max-width: 500px) {
        .search-options-title {
          display: none;
        }

        .search-fields-selected {
          padding: 0px 10px 10px 10px;
        }
      }

      .instructions-text {
        color: var(--primary-text-color);
        font-size: 16px;
        line-height: 18px;
        min-height: 18px;
      }

      .instructions-text > * {
        margin: 5px 0;
      }

      .instructions-text iron-icon {
        --iron-icon: {
          margin-left: 10px;
          margin-right: 20px;
          min-width: 20px;
        }
        --iron-icon-height: 20px;
        --iron-icon-width: 20px;
      }
    </style>

    <paper-button class="layout horizontal center bottom green" active="[[opened]]" on-tap="toggleSearchFieldsDialog" title="Click to Enter Search Terms">
      <iron-icon icon="search" class="bottom" style="margin-right: 5px;"></iron-icon>
      <span class="search-options-title">Click to Enter Search Terms</span>
    </paper-button>

    <styled-dialog
      class="search-dialog"
      modal
      opened="{{opened}}"
      on-opened-changed="toggleProcessRequest">

      <div class="layout vertical">
        <template is="dom-repeat" items="[[_searchFields]]" as="dialogConfig">
          <div class="layout horizontal">
            <template is="dom-if" if="[[_equalsDate(dialogConfig.type)]]">
              <div class="styled-dialog-name styled-dialog-right-space search-labels date-fields-title">[[dialogConfig.name]]</div>
              <div class="layout horizontal">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <div class="layout horizontal date-fields-container nowrap">
                    <date-picker-display
                      facet-key="value"
                      facets="{{searchConfig}}"
                      key="[[searchConfig.key]]"
                      prefix-label="[[searchConfig.title]]"
                      date-identifier="[[searchConfig.dateId]]"
                      title="[[searchConfig.title]]">
                    </date-picker-display>
                  </div>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[!_equalsDate(dialogConfig.type)]]">
              <div class="styled-dialog-name styled-dialog-right-space search-labels">[[dialogConfig.name]]</div>
              <div class="layout horizontal wrap">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <div class="layout horizontal nowrap">
                    <paper-input
                      id$="input_[[searchConfig.key]]"
                      label="[[searchConfig.title]]"
                      value="{{searchConfig.value}}"
                      on-keydown="_checkSearchFieldInputKey">
                    </paper-input>
                    <div class="layout vertical toggle-buttons">
                      <paper-icon-button
                        class$="net-exp [[_getActiveStyleClass(searchConfig.useInNetworkSearch)]]"
                        icon="fa:arrows-alt"
                        title="Click to Toggle Network Expansion of [[searchConfig.title]] (Currently [[_getActiveText(searchConfig.useInNetworkSearch)]])"
                        on-tap="_toggleNetworkExpansion">
                      </paper-icon-button>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>

      <div class="horizontal layout center-justified search-buttons">
        <button-action class="styled-dialog-button" icon="fa:search" text="Search" on-tap="handleSearch"></button-action>
        <button-action class="styled-dialog-button" icon="fa:undo" text="Reset" on-tap="resetAllSearchFields"></button-action>
        <button-action class="styled-dialog-button" icon="fa:times" text="Cancel" on-tap="cancelSearch"></button-action>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="layout vertical instructions-text">
        <div>
          <strong class="styled-dialog-right-space">Instructions:</strong>
          Enter words or phrases as <strong>search terms</strong> in one or more of the text fields below.
          Click the <strong>Search</strong> button or press the <strong>ENTER</strong> key when finished.
          Use <strong>commas</strong> to separate individual search terms.
          Use a <strong>plus sign</strong> (<strong>+</strong>) to mark a required word or phrase and a
          <strong>minus sign</strong> (<strong>-</strong>) to mark a word or phrase to ignore.
          Example:  <strong>+New York, Manhattan, -Newark</strong>
        </div>
        <div class="layout horizontal center">
          <iron-icon class="net-exp" icon="fa:arrows-alt"></iron-icon>
          <div>
            Activate <strong>network expansion</strong> on a field to run a <strong>multi-stage search</strong>:
            first, DIG will search with the listed search terms like normal;
            next, DIG will search with the terms of the network expansion fields in the results of the first search;
            then, DIG will show you the combined results of the two searches.
            Please note that it may take a minute or longer to run.
          </div>
        </div>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _, DigBehaviors */
    'use strict';

    Polymer({
      is: 'search-fields-dialog',
      behaviors: [DigBehaviors.FilterBehavior, DigBehaviors.PhoneBehavior],

      properties: {
        /**
         * The keys of dates in the searchFieldsConfig mapped to the keys of dates in the searchParameters.
         *
         * @type {Object}
         * @default {}
         */
        dateConfig: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * Whether the dialog is opened.
         *
         * @type {Boolean}
         * @default false
         */
        opened: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * Whether to let queries run.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },

        /**
         * Whether the user canceled the changes.
         *
         * @type {Boolean}
         * @default false
         */
        userCanceled: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * The data property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'data'
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * The date ID property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'dateIdentifier'
         */
        dataDateIdProperty: {
          type: String,
          value: 'dateIdentifier'
        },

        /**
         * The key property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'key'
         */
        dataKeyProperty: {
          type: String,
          value: 'key'
        },

        /**
         * The title property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'title'
         */
        dataTitleProperty: {
          type: String,
          value: 'title'
        },

        /**
         * The name property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'name'
         */
        nameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * The type property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'type'
         */
        typeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * The network expansion parameters passed in.
         *
         * @type {Object}
         */
        networkExpansionParameters: {
          type: Object,
          notify: true
        },

        /**
         * A list of objects that correspond to groupings of search fields.
         *
         * @type {Array}
         */
        searchFieldsConfig: {
          type: Array
        },

        /**
         * A function that transforms search parameter data into a search parameter object.
         *
         * @type {Object}
         * @default function(category, enabled, key, text, search, date) { return { category: category, date: date, enabled: enabled, key: key, search: search, text: text }; }
         */
        searchParameterTransform: {
          type: Object,
          value: function() {
            return function(category, enabled, key, text, search, date) {
              return {
                category: category,
                date: date,
                enabled: enabled,
                key: key,
                search: search,
                text: text
              };
            };
          }
        },

        /**
         * The search parameters created from the terms entered into the dialog.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * The search fields shown in the dialog.
         *
         * @type {Array}
         * @private
         */
        _searchFields: {
          computed: '_createSearchFields(searchFieldsConfig, dataProperty, nameProperty, typeProperty, dataDateIdProperty, dataKeyProperty, dataTitleProperty)',
          type: Array
        }
      },

      observers: [
        'toggleProcessRequest(searchParameters.*)'
      ],

      /**
       * Toggles whether to let queries run whenever the search parameters change or the dialog is opened or closed.
       */
      toggleProcessRequest: function() {
        this.processRequest = !this.opened && !this.userCanceled;
        // reset user canceled variable
        this.userCanceled = false;
      },

      /**
       * Updates the search fields shown in the dialog from the search parameters if opening the dialog, then opens or closes the dialog.
       */
      toggleSearchFieldsDialog: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        // Set or clear the search fields whenever the dialog is opened.
        if(!this.opened && this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self._updateDateFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex, 'value']);
                } else {
                  self._updateSearchFieldFromParameter(searchConfig);
                }
              });
            }
          });
        }

        this.opened = !this.opened;
      },

      /**
       * Creates and returns the search fields shown in the dialog.
       *
       * @param {Array} config
       * @param {String} dataProperty
       * @param {String} nameProperty
       * @param {String} typeProperty
       * @param {String} dataDateIdProperty
       * @param {String} dataKeyProperty
       * @param {String} dataTitleProperty
       * @return {Array}
       * @private
       */
      _createSearchFields: function(config, dataProperty, nameProperty, typeProperty, dataDateIdProperty, dataKeyProperty, dataTitleProperty) {
        var dateKeys = _.keys(this.dateConfig);
        return config.map(function(dialogConfig) {
          return {
            data: dialogConfig[dataProperty].map(function(searchConfig) {
              var isDate = (dateKeys.indexOf(searchConfig[dataKeyProperty]) >= 0);
              return {
                dateId: searchConfig[dataDateIdProperty],
                key: searchConfig[dataKeyProperty],
                title: searchConfig[dataTitleProperty],
                value: isDate ? {} : '',
                useInNetworkSearch: false
              };
            }),
            name: dialogConfig[nameProperty],
            type: dialogConfig[typeProperty]
          };
        });
      },

      /**
       * Returns whether the given argument is 'date'.
       *
       * @param {String} string
       * @return {Boolean}
       * @private
       */
      _equalsDate: function(string) {
        return string === 'date';
      },

      /**
       * Returns the active style class for the button with the given toggle status.
       *
       * @param {Boolean} active
       * @return {String}
       */
      _getActiveStyleClass: function(active) {
        return active ? 'active' : '';
      },

      /**
       * Returns the active text for the button with the given toggle status.
       *
       * @param {Boolean} active
       * @return {String}
       */
      _getActiveText: function(active) {
        return active ? 'On' : 'Off';
      },

      /**
       * Toggles the useInNetworkSearch property of the searchConfig in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleNetworkExpansion: function(event) {
        event.model.set('searchConfig.useInNetworkSearch', !event.model.searchConfig.useInNetworkSearch);
      },

      /**
       * Updates the searchParameters with a new object and notifies observers.
       *
       * @param {String} type
       * @param {String} term
       * @param {String} title
       * @param {Boolean} enabled
       * @private
       */
      _updateSearchParameterAndNotify: function(type, term, name, enabled, search) {
        this.searchParameters[type][term] = this.searchParameterTransform(name, enabled, term, term, search);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', type, '*'], this.searchParameterTransform(name, enabled, term, term, search));
      },

      /**
       * Updates the searchParameters and networkExpansionParameters from the given config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchAndNetworkParameterFromField: function(searchConfig) {
        var self = this;

        var terms = searchConfig.value.split(',').map(function(term) {
          return term.trim();
        }).reduce(function(terms, term) {
          var search = 'optional';
          var key = term;

          if(key.indexOf('+') === 0 || key.indexOf('-') === 0) {
            search = (key.indexOf('+') === 0 ? 'required' : 'ignore');
            key = key.substring(1);
          }

          // TODO Move custom formatting.
          if(searchConfig.key === 'phone') {
            key = DigBehaviors.PhoneBehavior.getUnformattedPhones(key);
          }

          if(key) {
            terms[key] = search;
          }

          return terms;
        }, {});

        _.keys(self.searchParameters[searchConfig.key]).forEach(function(term) {
          // Disable deleted terms.
          if(self.searchParameters[searchConfig.key][term].enabled && _.keys(terms).indexOf(term) < 0) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, false);
          }
        });

        _.keys(terms).forEach(function(term) {
          // Add new terms.
          if(term) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, true, terms[term]);
          }
        });

        // TODO: network expansion -- do we need notify?
        if(self.networkExpansionParameters[searchConfig.key] !== undefined &&
          self.networkExpansionParameters[searchConfig.key] !== searchConfig.useInNetworkSearch) {
          self.networkExpansionParameters[searchConfig.key] = searchConfig.useInNetworkSearch;
          self.notifyPath(['networkExpansionParameters', searchConfig.key], searchConfig.useInNetworkSearch);
        }
      },

      /**
       * Updates the searchParameters with a new date object and notifies observers.
       *
       * @param {String} key
       * @param {Object} date
       * @param {String} text
       * @param {String} category
       * @param {Boolean} enabled
       * @private
       */
      _updateDateParameterAndNotify: function(key, date, text, category, enabled) {
        var parameterKey = this.dateConfig[key];

        this.searchParameters[parameterKey][key] = this.searchParameterTransform(category, enabled, key, text, 'required', date);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', parameterKey, key], this.searchParameterTransform(category, enabled, key, text, 'required', date));
      },

      /**
       * Updates the searchParameters from the given date config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateDateParameterFromField: function(searchConfig) {

        var parameterKey = this.dateConfig[searchConfig.key];
        // TODO Don't assume data structure.
        if(!_.isEmpty(searchConfig.value[searchConfig.key])) {
          var dateObject = searchConfig.value[searchConfig.key];
          this._updateDateParameterAndNotify(dateObject.key, dateObject.date, dateObject.text, dateObject.category, dateObject.enabled);
        } else if(this.searchParameters[parameterKey][searchConfig.key]) {
          this.searchParameters[parameterKey][searchConfig.key] = {};
          this.notifyPath(['searchParameters', parameterKey, searchConfig.key], {});
        }
      },

      /**
       * Updates the searchParameters from the search fields in the dialog by adding or removing search terms.
       *
       * @private
       */
      _updateSearchParametersFromFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self._updateDateParameterFromField(searchConfig);
                } else {
                  self._updateSearchAndNetworkParameterFromField(searchConfig);
                }
              });
            }
          });
        }
      },

      /**
       * Updates the search field input of the given config object from the searchParameters.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchFieldFromParameter: function(searchConfig) {
        var self = this;
        searchConfig.value = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.searchParameters[searchConfig.key][term].enabled;
        }).map(function(term) {
          var prefix = self.searchParameters[searchConfig.key][term].search === 'required' ? '+' : (self.searchParameters[searchConfig.key][term].search === 'ignore' ? '-' : '');
          return prefix + self.searchParameters[searchConfig.key][term].text;
        }).join(', ');

        this.$$('#input_' + searchConfig.key).value = searchConfig.value;
      },

      /**
       * Updates the date input of the given config object from the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateDateFieldFromParameter: function(searchConfig, updatePath) {
        var parameterKey = this.dateConfig[searchConfig.key];
        searchConfig.value = {};
        if(this.searchParameters[parameterKey][searchConfig.key]) {
          searchConfig.value[searchConfig.key] = this.searchParameters[parameterKey][searchConfig.key];
        }
        this.set(updatePath, searchConfig.value);
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog so that new queries can run.
       */
      handleSearch: function() {
        this._updateSearchParametersFromFields();

        if(DigBehaviors.FilterBehavior.areAllFacetsDisabled(this.searchParameters, ['sort'])) {
          this.resetAllSearchFields();
          return;
        }

        this.toggleSearchFieldsDialog();
      },

      /**
       * Clears all of the search fields in the dialog.
       */
      resetAllSearchFields: function() {
        var self = this;
        var dateKeys = _.keys(this.dateConfig);

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dateKeys.indexOf(searchConfig.key) >= 0) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'value'], {});
                } else {
                  self.$$('#input_' + searchConfig.key).value = '';
                }
              });
            }
          });
        }
      },

      /**
       * Cancels the changes to the search fields and closes the dialog.
       */
      cancelSearch: function() {
        this.userCanceled = true;
        this.toggleSearchFieldsDialog();
      },

      /**
       * Updates the searchParameters from the search fields and closes the dialog if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _checkSearchFieldInputKey: function(event) {
        if(event.keyCode === 13) {
          this.handleSearch();
        }
      }
    });
  })();
  </script>
</dom-module>
