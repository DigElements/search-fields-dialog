<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../button-action/button-action.html">
<link rel="import" href="../image-gallery/image-gallery.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">
<link rel="import" href="../styled-dialog/styled-dialog-styles.html">
<link rel="import" href="../vaadin-date-picker-display/vaadin-date-picker-display.html">

<!--
A Polymer Element showing search fields in a modal dialog.

### Example
```html
<search-fields-dialog
  date-config='{"dateStart": "postingDate", "dateEnd": "postingDate"}'
  search-fields-config="[[searchFieldsConfig]]"
  search-parameters="{{searchParameters}}"
  process-request="{{processRequest}}">
</search-fields-dialog>
```

@demo demo/index.html
-->

<dom-module id="search-fields-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="styled-dialog-styles"></style>

    <style>
      :host {
        display: block;
      }

      .green[active],
      .green:hover {
        color: yellowgreen;
      }

      .search-label {
        text-align: end;
        /* Vertically align the search-label with their paper-input-containers. */
        padding-top: 22px;
      }

      .search-dialog paper-input {
        display: inline-block;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-input-color: var(--primary-text-color);
        --paper-input-container-focus-color: var(--primary-text-color);
        --paper-input-container: {
          padding: 0 5px 4px 20px;
          width: 275px;
        }
        --paper-input-container-input: {
          font-weight: 500;
        }
      }

      .search-dialog paper-input.add-width {
        --paper-input-container: {
          padding: 0 5px 4px 20px;
          width: 305px;
        }
      }

      .date-label {
        padding-top: 32px;
        text-align: end;
      }

      .image-label {
        padding-top: 5px;
        text-align: end;
      }

      vaadin-date-picker-display {
        display: inline-block;
        padding: 0 5px 4px 20px;
        width: 335px;
        --date-select-bg-color: #ffffff;
        --date-select-text-color: #000000;
      }

      .search-dialog {
        --styled-dialog-min-width: 825px;
        --styled-dialog-max-width: 825px;
      }

      .search-dialog {
        --styled-dialog-max-width: 840px;
        --styled-dialog-style-mixin: {
          overflow: auto;
        };
        --styled-dialog-inside-style-mixin: {
          overflow: none;
        };
      }

      .styled-dialog-name {
        max-width: var(--styled-dialog-label-width, 100px);
        min-width: var(--styled-dialog-label-width, 100px);
        overflow: hidden;
        text-overflow: ellipsis;
      }

      styled-dialog.backdrop {
        --styled-dialog-style-mixin: {
          opacity: 0.6;
        };
      }

      .image-list {
        margin-left: 20px;
        margin-bottom: 5px;
      }

      .image-item {
        cursor: default;
        display: -webkit-box;
        overflow: hidden;
        padding-right: 5px;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 695px;
        word-break: break-word;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
      }

      .image-item a {
        color: inherit;
      }

      .image-item a:hover {
        color: var(--secondary-text-color);
      }

      .selected {
        background-color: var(--primary-background-color);
      }

      .hovering {
        background-color: yellow;
      }

      image-gallery {
        --image-hovering-color: yellow;
        --image-selected-color: var(--primary-background-color);
        margin-left: 15px;
      }

      .image-item paper-icon-button,
      .toggle-buttons paper-icon-button {
        border-radius: 50%;
        color: var(--disabled-text-color);
        cursor: pointer;
        height: 30px;
        width: 30px;
        min-width: 30px;
        padding: 5px;
      }

      .image-item paper-icon-button.on {
        color: var(--primary-text-color);
      }

      .toggle-buttons paper-icon-button {
        /* Vertically align the toggle-buttons with their search-label & paper-input-containers. */
        margin-top: 15px;
      }

      .network-expansion-icon:hover,
      .network-expansion-icon.on {
        color: yellowgreen;
      }

      .network-expansion-icon.on.inactive {
        color: orangered;
      }

      .require-one-icon:hover,
      .require-one-icon.on {
        color: gold;
      }

      .help-dialog {
        --styled-dialog-min-width: 800px;
        --styled-dialog-max-width: 800px;
      }

      .help-text {
        color: var(--primary-text-color);
        font-size: 16px;
        line-height: 18px;
        min-height: 18px;
      }

      iron-icon {
        --iron-icon-height: 30px;
        --iron-icon-width: 30px;
        --iron-icon: {
          margin: 0 5px;
          min-width: 30px;
        }
      }

      .help-text > div {
        margin-left: 15px;
      }

      .network-expansion-info {
        padding-top: 10px;
      }

      .search-buttons > button-action {
        margin: 5px 10px;
      }

      .search-options-title {
        font-size: 24px;
        font-weight: 500;
        text-transform: none;
      }
    </style>

    <paper-button class="layout horizontal center green" active="[[opened]]" on-tap="toggleSearchFieldsDialog" title="Click to Enter Search Terms">
      <iron-icon icon="fa:search"></iron-icon>
      <span class="search-options-title">Click to Enter Search Terms</span>
    </paper-button>

    <styled-dialog
      class$="search-dialog [[_isBackdrop(_helpOpened)]]"
      modal
      opened="{{opened}}">

      <div class="layout horizontal center-justified search-buttons">
        <button-action icon="fa:search" text="Search" on-tap="handleSearch"></button-action>
        <button-action icon="fa:undo" text="Reset" on-tap="resetAllSearchFields"></button-action>
        <button-action icon="fa:times" text="Cancel" on-tap="cancelSearch"></button-action>
        <button-action icon="fa:question" text="Help" on-tap="openHelp"></button-action>
      </div>

      <template is="dom-repeat" items="[[_searchFields]]" as="dialogConfig">
        <div class="layout horizontal">
          <template is="dom-if" if="[[dialogConfig.isDate]]">
            <div class="styled-dialog-name date-label">[[dialogConfig.name]]</div>
            <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
              <div class="layout horizontal date-fields-container nowrap">
                <vaadin-date-picker-display
                  facet-key="value"
                  facets="{{searchConfig}}"
                  key="[[searchConfig.key]]"
                  category="[[searchConfig.title]]">
                </vaadin-date-picker-display>
              </div>
            </template>
          </template>

          <template is="dom-if" if="[[!dialogConfig.isDate]]">
            <template is="dom-if" if="[[dialogConfig.isImage]]">
              <div class="styled-dialog-name image-label">[[dialogConfig.name]]</div>
              <div class="layout vertical">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <div class="layout vertical image-list">
                    <template is="dom-repeat" items="[[searchConfig.images]]" as="image">
                      <div class$="layout horizontal center image-item [[_isInList(searchConfig.selected, image.id, 'selected')]] [[_isInList(searchConfig.hovering, image.id, 'hovering')]]"
                        on-mouseover="_hoverImageBegin"
                        on-mouseout="_hoverImageEnd">

                        <paper-icon-button
                          class$="[[_getImageButtonStyleClass(searchConfig.selected, image.id)]]"
                          icon="fa:search"
                          title$="[[_getImageSearchButtonText(searchConfig.selected, image.id)]]"
                          on-tap="_toggleImageSearch"></paper-icon-button>

                        <paper-icon-button
                          class$="[[_getImageButtonStyleClass(searchConfig.selected, image.id, image.search, 'required')]]"
                          icon="fa:plus"
                          title$="[[_getImageRequiredButtonText(image.search)]]"
                          on-tap="_toggleImageRequired"></paper-icon-button>

                        <paper-icon-button
                          class$="[[_getImageButtonStyleClass(searchConfig.selected, image.id, image.search, 'excluded')]]"
                          icon="fa:minus"
                          title$="[[_getImageExcludedButtonText(image.search)]]"
                          on-tap="_toggleImageExcluded"></paper-icon-button>

                        <a href$="[[image.source]]" target="_blank" title="Click to Open Image">[[image.id]]</a>
                      </div>
                    </template>
                  </div>

                  <image-gallery
                    hovering="{{searchConfig.hovering}}"
                    images="[[searchConfig.images]]"
                    selected="[[searchConfig.selected]]"></image-gallery>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[!dialogConfig.isImage]]">
              <div class="styled-dialog-name search-label">[[dialogConfig.name]]</div>
              <div class="layout horizontal wrap">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <div class="layout horizontal nowrap">
                    <paper-input
                      class$="[[_getInputWidthStyleClass(searchConfig.enableNetworkExpansion)]]"
                      id$="input_[[searchConfig.key]]"
                      label="[[searchConfig.title]]"
                      value="{{searchConfig.value}}"
                      on-keyup="_didUserHitEnterKey">
                    </paper-input>

                    <div class="layout horizontal toggle-buttons">
                      <template is="dom-if" if="[[searchConfig.enableNetworkExpansion]]">
                        <paper-icon-button
                          class$="network-expansion-icon [[_getNetworkExpansionStyleClass(searchConfig.activateNetworkExpansion, _isNetworkExpansionViable)]]"
                          icon="fa:arrows-alt"
                          title="Click to Toggle Network Expansion of [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.activateNetworkExpansion)]])"
                          on-tap="_toggleNetworkExpansion">
                        </paper-icon-button>
                      </template>

                      <paper-icon-button
                        class$="require-one-icon [[_getButtonStyleClass(searchConfig.requireOne)]]"
                        icon="fa:asterisk"
                        title="Click to Require at Least One Term from [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.requireOne)]])"
                        on-tap="_toggleRequireOne">
                      </paper-icon-button>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </template>
        </div>
      </template>
    </styled-dialog>

    <styled-dialog class="help-dialog" header="Search Help" opened="{{_helpOpened}}">
      <div class="help-text">
        Enter words or phrases as <strong>search terms</strong> in one or more text fields.
        Use <strong>commas</strong> to separate search terms.
      </div>
      <div class="help-text">
        A phrase of multiple words (without commas) is treated as a <strong>single</strong> search term (no quotation marks needed).
      </div>
      <div class="help-text">
        Use a <strong>plus sign</strong> (<strong>+</strong>) to mark a <strong>required</strong> search term and a
        <strong>minus sign</strong> (<strong>-</strong>) to mark an <strong>excluded</strong> search term.
      </div>
      <div class="help-text">
        Click the <strong>SEARCH</strong> button or press the <strong>ENTER</strong> key to run the search.
        Click the <strong>RESET</strong> button to clear all terms.
      </div>
      <div class="help-text">
        Example:  <strong>+New York, New Jersey, -New Hampshire</strong>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="require-one-icon on" icon="fa:asterisk"></iron-icon>
        <div>
          Click the <strong>asterisk</strong> button to <strong>require at least one term from a field</strong> to match every search result.
          (Terms may still be marked as excluded.)
          This is helpful if you want results that match one term but don't need results that match all terms simultaneously.
          Example:  <strong>New York, Bronx, Brooklyn, Manhattan, Queens</strong>
        </div>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="network-expansion-icon on" icon="fa:arrows-alt"></iron-icon>
        <div class="layout vertical">
          <div>
            Click the <strong>expand</strong> button to activate <strong>network expansion</strong> on a field and run a <strong>multi-stage search</strong>:
            first, DIG finds results that match the search terms like normal;
            next, DIG finds results that match the terms in the network expansion fields from the results of the first search;
            then, DIG shows the combined results.
          </div>
          <div style="margin-top: 10px;">
            Network expansion will only work if one or more network expansion fields have one or more search terms.
            Please note that it may take a minute or more to run a search with network expansion activated.
          </div>
        </div>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _ */
    'use strict';

    Polymer({
      is: 'search-fields-dialog',

      properties: {
        /**
         * (Optional)
         *
         * A function that returns whether all the search parameters in the given object are disabled (or empty).
         *
         * @type {Object}
         * @default function
         */
        areSearchParametersDisabled: {
          type: Object,
          value: function() {
            return function(searchParameters) {
              return _.keys(searchParameters).every(function(type) {
                if(_.isEmpty(searchParameters[type])) {
                  return true;
                }
                return _.keys(searchParameters[type]).every(function(term) {
                  return !searchParameters[type][term].enabled;
                });
              });
            };
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms search parameter data into a search parameter object.
         *
         * @type {Object}
         * @default function(category, enabled, key, text, search, date) { return { category: category, date: date, enabled: enabled, key: key, search: search, text: text }; }
         */
        buildSearchParameter: {
          type: Object,
          value: function() {
            return function(category, enabled, key, text, search, date) {
              return {
                category: category,
                date: date,
                enabled: enabled,
                key: key,
                search: search,
                text: text
              };
            };
          }
        },

        /**
         * (Optional)
         *
         * The data property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'data'
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * (Optional)
         *
         * The key property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'key'
         */
        dataKeyProperty: {
          type: String,
          value: 'key'
        },

        /**
         * (Optional)
         *
         * The title property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'title'
         */
        dataTitleProperty: {
          type: String,
          value: 'title'
        },

        /**
         * (Optional)
         *
         * The keys of dates in the searchFieldsConfig mapped to the keys of dates in the searchParameters.
         *
         * @type {Object}
         * @default {}
         */
        dateConfig: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms a search parameter object into an object with "enabled", "search", and "text" properties.
         *
         * @type {Object}
         * @default function(searchParameter) { return { enabled: searchParameter.enabled, search: searchParameter.search, text: searchParameter.text }; }
         */
        getSearchParameterData: {
          type: Object,
          value: function() {
            return function(searchParameter) {
              return {
                enabled: searchParameter.enabled,
                search: searchParameter.search,
                text: searchParameter.text
              };
            };
          }
        },

        /**
         * (Optional)
         *
         * The prefix for the image URL for image field data.
         *
         * @type {String}
         * @default ''
         */
        imageUrlPrefix: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The name property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'name'
         */
        nameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * (Optional|Output)
         *
         * The network expansion parameters passed in.
         *
         * @type {Object}
         */
        networkExpansionParameters: {
          type: Object,
          notify: true
        },

        /**
         * (Optional|Output)
         *
         * Whether the dialog is opened.
         *
         * @type {Boolean}
         * @default false
         */
        opened: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Optional|Output)
         *
         * Whether to let queries run.
         *
         * @type {Boolean}
         */
        processRequest: {
          notify: true,
          type: Boolean
        },

        /**
         * (Required|Output)
         *
         * A list of objects that correspond to groupings of search fields.
         *
         * @type {Array}
         */
        searchFieldsConfig: {
          type: Array
        },

        /**
         * (Required|Output)
         *
         * The search parameters created from the terms entered into the dialog.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * (Optional)
         *
         * The type property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'type'
         */
        typeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * (Optional|Output)
         *
         * Whether the user canceled the changes.
         *
         * @type {Boolean}
         * @default false
         */
        userCanceled: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * Whether the help dialog is opened.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _helpOpened: {
          type: Boolean,
          value: false
        },

        /**
         * Whether network expansion is viable based on the fields and values.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _isNetworkExpansionViable: {
          type: Boolean,
          value: false
        },

        /**
         * The search fields shown in the dialog.
         *
         * @type {Array}
         * @private
         */
        _searchFields: {
          computed: '_createSearchFields(searchFieldsConfig, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty)',
          type: Array
        }
      },

      observers: [
        'toggleProcessRequest(searchParameters.*, opened)'
      ],

      /**
       * Creates and returns the search fields shown in the dialog.
       *
       * @param {Array} config
       * @param {String} dataProperty
       * @param {String} nameProperty
       * @param {String} typeProperty
       * @param {String} dataKeyProperty
       * @param {String} dataTitleProperty
       * @return {Array}
       * @private
       */
      _createSearchFields: function(config, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty) {
        var self = this;
        return (config || []).map(function(dialogConfig) {
          var isDate = dialogConfig[typeProperty] === 'date';
          var isImage = dialogConfig[typeProperty] === 'image';
          return {
            data: dialogConfig[dataProperty].map(function(searchConfig) {
              var item = {
                key: searchConfig[dataKeyProperty],
                title: searchConfig[dataTitleProperty]
              };

              if(!isImage) {
                item.value = isDate ? {} : '';
              }

              if(!isImage && !isDate) {
                item.activateNetworkExpansion = false;
                item.activateNetworkExpansionPrevious = false;
                item.enableNetworkExpansion = (searchConfig.enableNetworkExpansion || false);
                item.requireOne = true;
                item.requireOnePrevious = true;
              }

              if(isImage) {
                item.hovering = [];
                item.images = [];
                item.selected = [];
              }

              return item;
            }),
            isDate: isDate,
            isImage: isImage,
            name: dialogConfig[nameProperty]
          };
        });
      },

      /**
       * Updates the searchParameters using the search fields and closes the dialog if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _didUserHitEnterKey: function(event) {
        this._updateNetworkExpansion();
        if(event.keyCode === 13) {
          this.handleSearch();
        }
      },

      /**
       * Returns the style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonStyleClass: function(on) {
        return on ? 'on' : '';
      },

      /**
       * Returns the text for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonText: function(on) {
        return on ? 'On' : 'Off';
      },

      /**
       * Returns the style class of an image button.
       *
       * @param {Array} list
       * @param {Number|String} id
       * @param {String} search
       * @param {String} type
       * @return {String}
       * @private
       */
      _getImageButtonStyleClass: function(list, id, search, type) {
        return (list.indexOf(id) >= 0 && (_.isUndefined(type) ? true : search === type)) ? 'on' : '';
      },

      /**
       * Returns the text of the "excluded" image button.
       *
       * @param {String} search
       * @return {String}
       * @private
       */
      _getImageExcludedButtonText: function(search) {
        return (search === 'excluded' ? 'Click to Not Exclude Image from Search Results' : 'Click to Exclude Image from Search Results');
      },

      /**
       * Returns the text of the "required" image button.
       *
       * @param {String} search
       * @return {String}
       * @private
       */
      _getImageRequiredButtonText: function(search) {
        return (search === 'required' ? 'Click to Not Require Image in Search Results' : 'Click to Require Image in Search Results');
      },

      /**
       * Returns the text of the "search" image button.
       *
       * @param {Array} list
       * @param {Number|String} id
       * @return {String}
       * @private
       */
      _getImageSearchButtonText: function(list, id) {
        return (list.indexOf(id) >= 0 ? 'Click to Remove Image from Search' : 'Click to Add Image to Search');
      },

      /**
       * Returns the style class of an input element.
       *
       * @param {Boolean} enableNetworkExpansion
       * @return {String}
       * @private
       */
      _getInputWidthStyleClass: function(enableNetworkExpansion) {
        return enableNetworkExpansion ? '' : 'add-width';
      },

      /**
       * Returns the network expansion style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @param {Boolean} active
       * @return {String}
       * @private
       */
      _getNetworkExpansionStyleClass: function(on, active) {
        return this._getButtonStyleClass(on) + (active ? '' : ' inactive');
      },

      /**
       * Begins hovering over an image using the search config object and image ID in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _hoverImageBegin: function(event) {
        event.model.set('searchConfig.hovering', [event.model.image.id]);
      },

      /**
       * Ends hovering over an image using the search config object and image ID in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _hoverImageEnd: function(event) {
        event.model.set('searchConfig.hovering', []);
      },

      /**
       * Returns the backdrop style class.
       *
       * @param {Boolean} helpOpened
       * @return {String}
       * @private
       */
      _isBackdrop: function(helpOpened) {
        return helpOpened ? 'backdrop' : '';
      },

      /**
       * Returns the given object if the given ID is in the given list.
       *
       * @param {Array} list
       * @param {Number|String} id
       * @param {Object} object
       * @return {Object}
       * @private
       */
      _isInList: function(list, id, object) {
        return list.indexOf(id) >= 0 ? object : '';
      },

      /**
       * Selects an image and toggles its excluded status using the search config object and image ID/search status in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleImageExcluded: function(event) {
        var search = event.model.image.search === 'excluded' ? 'optional' : 'excluded';
        event.model.set('image.search', search);

        // Add image ID to list of selected image IDs (if not there already).
        var index = event.model.searchConfig.selected.indexOf(event.model.image.id);
        if(index < 0) {
          // Use the map function to create a new array.
          var selected = event.model.searchConfig.selected.map(function(id) {
            return id;
          });
          selected.push(event.model.image.id);
          event.model.set('searchConfig.selected', selected);
        }
      },

      /**
       * Selects an image and toggles its required status using the search config object and image ID/search status in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleImageRequired: function(event) {
        var search = event.model.image.search === 'required' ? 'optional' : 'required';
        event.model.set('image.search', search);

        // Add image ID to list of selected image IDs (if not there already).
        var index = event.model.searchConfig.selected.indexOf(event.model.image.id);
        if(index < 0) {
          // Use the map function to create a new array.
          var selected = event.model.searchConfig.selected.map(function(id) {
            return id;
          });
          selected.push(event.model.image.id);
          event.model.set('searchConfig.selected', selected);
        }
      },

      /**
       * Toggles the selected status of an image using the search config object and image ID/search status in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleImageSearch: function(event) {
        event.model.set('image.search', 'optional');

        var index = event.model.searchConfig.selected.indexOf(event.model.image.id);

        // Use the map function to create a new array.
        var selected = event.model.searchConfig.selected.map(function(id) {
          return id;
        });

        if(index < 0) {
          selected.push(event.model.image.id);
        } else {
          selected.splice(index, 1);
        }

        event.model.set('searchConfig.selected', selected);
      },

      /**
       * Toggles the activateNetworkExpansion property of the searchConfig in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleNetworkExpansion: function(event) {
        event.model.set('searchConfig.activateNetworkExpansion', !event.model.searchConfig.activateNetworkExpansion);
        this._updateNetworkExpansion();
      },

      /**
       * Toggles the requireOne property of the searchConfig in the model of the given event.
       *
       * @param {Event} event
       * @private
       */
      _toggleRequireOne: function(event) {
        event.model.set('searchConfig.requireOne', !event.model.searchConfig.requireOne);
      },

      /**
       * Returns a string of unformatted phones separated by newlines.
       *
       * @param {String} phone
       * @return {String}
       * @private
       */
      _unformatPhones: function(phone) {
        // Replace all delimiters (whitespace, commas, and, semicolons) with single spaces.
        return phone.replace(/[\s,;]/g, ' ')
          // Remove all non-digit, non-whitespace characters.
          .replace(/[^\d\s]/g, '')
          // Remove extra spaces.
          .replace(/\s+/g, '\n')
          .trim();
      },

      /**
       * Updates the date input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateDateFieldFromParameter: function(searchConfig, updatePath) {
        var parameterKey = this.dateConfig[searchConfig.key];
        searchConfig.value = {};
        if(this.searchParameters[parameterKey][searchConfig.key]) {
          searchConfig.value[searchConfig.key] = this.searchParameters[parameterKey][searchConfig.key];
        }
        this.notifyPath(updatePath.concat('value'), searchConfig.value);
      },

      /**
       * Updates the searchParameters with a new date object and notifies observers.
       *
       * @param {String} key
       * @param {Object} date
       * @param {String} text
       * @param {String} category
       * @param {Boolean} enabled
       * @private
       */
      _updateDateParameterAndNotify: function(key, date, text, category, enabled) {
        var parameterKey = this.dateConfig[key];

        this.searchParameters[parameterKey][key] = this.buildSearchParameter(category, enabled, key, text, 'required', date);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', parameterKey, key], this.buildSearchParameter(category, enabled, key, text, 'required', date));
      },

      /**
       * Updates the searchParameters using the given date config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateDateParameterFromField: function(searchConfig) {
        var parameterKey = this.dateConfig[searchConfig.key];
        // TODO Don't assume data structure.
        if(!_.isEmpty(searchConfig.value[searchConfig.key])) {
          var dateObject = searchConfig.value[searchConfig.key];
          this._updateDateParameterAndNotify(dateObject.key, dateObject.date, dateObject.text, dateObject.category, dateObject.enabled);
        } else if(this.searchParameters[parameterKey][searchConfig.key]) {
          this.searchParameters[parameterKey][searchConfig.key] = {};
          this.notifyPath(['searchParameters', parameterKey, searchConfig.key], {});
        }
      },

      /**
       * Updates the image gallery input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateImageGalleryFromParameter: function(searchConfig, updatePath) {
        var self = this;
        var images = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).enabled;
        }).map(function(term) {
          var search = self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).search;
          return {
            id: term,
            search: search || 'optional',
            source: self.imageUrlPrefix + term
          };
        });

        this.set(updatePath.concat('images'), images);
        this.set(updatePath.concat('selected'), images.map(function(object) {
          return object.id;
        }));
      },

      /**
       * Updates the searchParameters using the given search config object by adding or removing selected images.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateImageParameterFromGallery: function(searchConfig) {
        var searchTermToSearchStatus = searchConfig.images.reduce(function(searchTermToSearchStatus, image) {
          if(searchConfig.selected.indexOf(image.id) >= 0) {
            searchTermToSearchStatus[image.id] = image.search;
          }
          return searchTermToSearchStatus;
        }, {});

        this._updateSearchParameterTerms(searchConfig, searchTermToSearchStatus);
      },

      /**
       * Updates whether network expansion is active based on the active network expansion fields and values in network expansion fields.
       *
       * @private
       */
      _updateNetworkExpansion: function() {
        // Find all fields for which network expansion is active.
        var fields = this._searchFields.reduce(function(fields, dialogConfig) {
          return fields.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.activateNetworkExpansion;
          }).map(function(searchConfig) {
            return searchConfig.title;
          }));
        }, []);

        // Find all values (search terms) in fields with the network expansion option.
        var values = this._searchFields.reduce(function(values, dialogConfig) {
          return values.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.enableNetworkExpansion && !!(searchConfig.value.trim());
          }).map(function(searchConfig) {
            return searchConfig.value.trim();
          }));
        }, []).reduce(function(values, value) {
          // Split values into individual search terms.
          return values.concat(value.split(',').map(function(term) {
            return term.trim();
          }).filter(function(term) {
            return term && term !== '+' && term !== '-';
          }));
        }, []);

        this._isNetworkExpansionViable = (fields.length && values.length);
      },

      /**
       * Updates the search field input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateSearchFieldFromParameter: function(searchConfig, updatePath) {
        var self = this;
        var termData = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).enabled;
        }).map(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]);
        });

        searchConfig.value = termData.map(function(data) {
          var prefix = (data.search === 'required' ? '+' : (data.search === 'excluded' ? '-' : ''));
          return prefix + data.text;
        }).join(', ');
        this.$$('#input_' + searchConfig.key).value = searchConfig.value;

        searchConfig.activateNetworkExpansion = this.networkExpansionParameters[searchConfig.key] || searchConfig.activateNetworkExpansion;
        this.notifyPath(updatePath.concat(['activateNetworkExpansion']), searchConfig.activateNetworkExpansion);

        searchConfig.requireOne = !termData.length ? searchConfig.requireOne : termData.some(function(data) {
          return data.search === 'union';
        });
        this.notifyPath(updatePath.concat(['requireOne']), searchConfig.requireOne);
      },

      /**
       * Updates the searchParameters with a new object and notifies observers.
       *
       * @param {String} type
       * @param {String} term
       * @param {String} title
       * @param {Boolean} enabled
       * @private
       */
      _updateSearchParameterAndNotify: function(type, term, name, enabled, search) {
        this.searchParameters[type][term] = this.buildSearchParameter(name, enabled, term, term, search);

        // TODO Do we really need to create a new object for the second argument?  Do we need to use an object at all?
        this.notifyPath(['searchParameters', type, '*'], this.buildSearchParameter(name, enabled, term, term, search));
      },

      /**
       * Updates the searchParameters and networkExpansionParameters using the given config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchParameterFromField: function(searchConfig) {
        var self = this;

        var searchTermToSearchStatus = searchConfig.value.split(',').map(function(term) {
          return term.trim();
        }).reduce(function(searchTermToSearchStatus, term) {
          var search = searchConfig.requireOne ? 'union' : 'optional';
          var key = term;

          // A required or excluded term overrides searchConfig.requireOne.
          if(key.indexOf('+') === 0 || key.indexOf('-') === 0) {
            search = key.indexOf('+') === 0 ? 'required' : 'excluded';
            key = key.substring(1);
          }

          // TODO Move custom formatting.
          if(searchConfig.key === 'phone') {
            key = self._unformatPhones(key);
          }

          if(key) {
            searchTermToSearchStatus[key] = search;
          }

          return searchTermToSearchStatus;
        }, {});

        this._updateSearchParameterTerms(searchConfig, searchTermToSearchStatus);

        var activateNetworkExpansion = (this._isNetworkExpansionViable && searchConfig.activateNetworkExpansion);

        if(this.networkExpansionParameters[searchConfig.key] !== activateNetworkExpansion) {
          this.networkExpansionParameters[searchConfig.key] = activateNetworkExpansion;
          this.notifyPath(['networkExpansionParameters', searchConfig.key], this.networkExpansionParameters[searchConfig.key]);
        }
      },

      /**
       * Updates the searchParameters using the search fields in the dialog by adding or removing search terms.
       *
       * @private
       */
      _updateSearchParametersFromFields: function() {
        var self = this;

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig) {
                if(dialogConfig.isDate) {
                  self._updateDateParameterFromField(searchConfig);
                } else if(dialogConfig.isImage) {
                  self._updateImageParameterFromGallery(searchConfig);
                } else {
                  self._updateSearchParameterFromField(searchConfig);
                }
              });
            }
          });
        }
      },

      /**
       * Updates the searchParameters for the given searchConfig using the given search terms.
       *
       * @param {Object} searchConfig
       * @param {Object} searchTermToSearchStatus
       * @private
       */
      _updateSearchParameterTerms: function(searchConfig, searchTermToSearchStatus) {
        var self = this;

        _.keys(self.searchParameters[searchConfig.key]).forEach(function(term) {
          // Disable deleted terms.
          if(self.searchParameters[searchConfig.key][term].enabled && _.keys(searchTermToSearchStatus).indexOf(term) < 0) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, false);
          }
        });

        _.keys(searchTermToSearchStatus).forEach(function(term) {
          // Add new terms.
          if(term) {
            self._updateSearchParameterAndNotify(searchConfig.key, term, searchConfig.title, true, searchTermToSearchStatus[term]);
          }
        });
      },

      /**
       * Cancels the changes to the search fields and closes the dialog.
       */
      cancelSearch: function() {
        this._searchFields.forEach(function(dialogConfig) {
          dialogConfig.data.forEach(function(searchConfig) {
            searchConfig.activateNetworkExpansion = searchConfig.activateNetworkExpansionPrevious;
            searchConfig.requireOne = searchConfig.requireOnePrevious;
          });
        });

        this.userCanceled = true;
        this.toggleSearchFieldsDialog();
      },

      /**
       * Updates the searchParameters using the search fields and closes the dialog so that new queries can run.
       */
      handleSearch: function() {
        this._searchFields.forEach(function(dialogConfig) {
          dialogConfig.data.forEach(function(searchConfig) {
            searchConfig.activateNetworkExpansionPrevious = searchConfig.activateNetworkExpansion;
            searchConfig.requireOnePrevious = searchConfig.requireOne;
          });
        });

        this._updateSearchParametersFromFields();

        if(this.areSearchParametersDisabled(this.searchParameters)) {
          this.resetAllSearchFields();
          return;
        }

        this.toggleSearchFieldsDialog();
      },

      /**
       * Opens the help dialog.
       */
      openHelp: function() {
        this.set('_helpOpened', true);
      },

      /**
       * Clears all of the search fields in the dialog.
       */
      resetAllSearchFields: function() {
        var self = this;

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dialogConfig.isDate) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'value'], {});
                } else if(dialogConfig.isImage) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'selected'], []);
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'images'], []);
                } else {
                  self.$$('#input_' + searchConfig.key).value = '';
                }
              });
            }
          });
        }
      },

      /**
       * Toggles whether to let queries run whenever the search parameters change or the dialog is opened or closed.
       */
      toggleProcessRequest: function() {
        this.processRequest = !this.opened && !this.userCanceled;
        // reset user canceled variable
        this.userCanceled = false;
      },

      /**
       * Updates the search fields shown in the dialog using the search parameters if opening the dialog, then opens or closes the dialog.
       */
      toggleSearchFieldsDialog: function() {
        var self = this;

        // Set or clear the search fields whenever the dialog is opened.
        if(!this.opened && this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dialogConfig.isDate) {
                  self._updateDateFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                } else if(dialogConfig.isImage) {
                  self._updateImageGalleryFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                } else {
                  self._updateSearchFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                }
              });
            }
          });
        }

        this.opened = !this.opened;
      }
    });
  })();
  </script>
</dom-module>
