<!--
Copyright 2017 Next Century Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../auto-paginated-image-gallery/auto-paginated-image-gallery.html">
<link rel="import" href="../button-action/button-action.html">
<link rel="import" href="../fontawesome-iconset/fa-all.html">
<link rel="import" href="../image-gallery/image-gallery.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../search-image-gallery/search-image-gallery.html">
<link rel="import" href="../styled-dialog/styled-dialog.html">
<link rel="import" href="../styled-dialog/styled-dialog-styles.html">
<link rel="import" href="../vaadin-date-picker-display/vaadin-date-picker-display.html">
<link rel="import" href="../vaadin-upload/vaadin-upload.html">

<!--
A Polymer Element showing search fields in a modal dialog.

### Example
```html
<search-fields-dialog
  date-config='{"dateStart": "postingDate", "dateEnd": "postingDate"}'
  search-fields-config="[[searchFieldsConfig]]"
  search-parameters="{{searchParameters}}"
  process-request="{{processRequest}}">
</search-fields-dialog>
```

@demo demo/index.html
-->

<dom-module id="search-fields-dialog">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style include="styled-dialog-styles"></style>

    <style>
      :host {
        display: block;
      }

      iron-icon {
        --iron-icon-height: 30px;
        --iron-icon-width: 30px;
        --iron-icon: {
          margin: 0 5px;
          min-width: 30px;
        }
      }

      .open-dialog-button[active],
      .open-dialog-button:hover {
        color: greenyellow;
      }

      .open-dialog-button > div {
        font-size: 24px;
        font-weight: 500;
        text-transform: none;
      }

      [slot="top"] {
        margin-bottom: 10px;
      }

      .header > button-action {
        margin: 5px 10px;
      }

      .footer {
        margin-top: 10px;
      }

      .search-dialog {
        --styled-dialog-min-width: 920px;
        --styled-dialog-max-width: 920px;
        --styled-dialog-style-mixin: {
          max-width: 980px;
          min-width: 980px;
          overflow: auto;
        };
        --styled-dialog-inside-style-mixin: {
          overflow: none;
        };
      }

      .search-dialog.backdrop {
        --styled-dialog-style-mixin: {
          max-width: 980px;
          min-width: 980px;
          opacity: 0.6;
          overflow: auto;
        };
      }

      .search-dialog .styled-dialog-name {
        max-width: var(--styled-dialog-label-width, 100px);
        min-width: var(--styled-dialog-label-width, 100px);
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .search-name {
        text-align: end;
        /* Vertically align the label with their paper-input-containers. */
        padding-top: 24px;
      }

      .images-name {
        text-align: end;
        padding-top: 5px;
      }

      .no-images {
        margin-left: 20px;
        padding-top: 5px;
      }

      vaadin-date-picker-display {
        display: inline-block;
        padding: 2px 10px 2px 20px;
        width: 370px;
        --date-picker-style-mixin: {
          padding-bottom: 0;
        };
      }

      paper-input {
        width: 100%;
        --paper-input-container-color: var(--secondary-text-color);
        --paper-input-container-input-color: var(--primary-text-color);
        --paper-input-container-focus-color: var(--primary-text-color);
        --paper-input-container: {
          padding: 2px 0;
        }
        --paper-input-container-input: {
          font-weight: 500;
        }
      }

      .search-data paper-input {
        --paper-input-container: {
          padding: 2px 0 2px 20px;
          width: 320px;
        }
      }

      .search-data paper-input.add-width {
        --paper-input-container: {
          padding: 2px 0 2px 20px;
          width: 350px;
        }
      }

      .selected {
        background-color: var(--primary-background-color);
      }

      .hovering {
        background-color: yellow;
      }

      auto-paginated-image-gallery {
        --auto-paginated-image-gallery-hovering-color: yellow;
        --auto-paginated-image-gallery-selected-color: var(--primary-background-color);
        --auto-paginated-image-gallery-max-height: none;
        --auto-paginated-image-gallery-show-more-button: {
          margin-top: 10px;
        };
      }

      image-gallery,
      search-image-gallery {
        --image-gallery-hovering-color: yellow;
        --image-gallery-selected-color: var(--primary-background-color);
      }

      search-image-gallery {
        margin: 0 10px 0 20px;
      }

      image-gallery.input-gallery {
        margin-right: 10px;
        /* Max Height = 1 Row of Images */
        max-height: 160px;
        overflow: auto;
      }

      .link-data {
        margin: 10px;
      }

      paper-icon-button {
        border-radius: 50%;
        cursor: pointer;
        height: 30px;
        width: 30px;
        min-width: 30px;
        padding: 0;
      }

      .link-data paper-icon-button,
      .search-data paper-icon-button {
        color: var(--disabled-text-color);
        padding: 5px;
      }

      paper-icon-button.on {
        color: var(--primary-text-color);
      }

      vaadin-upload {
        margin: 10px;
        padding: 10px;
        --vaadin-upload-file-list: {
          display: none;
        };
      }

      .search-data paper-icon-button {
        /* Vertically align the buttons with their label & paper-input-containers. */
        margin-top: 20px;
      }

      .network-expansion-icon:hover,
      .network-expansion-icon.on {
        color: var(--paper-green-600, green);
      }

      .network-expansion-icon.on.inactive {
        color: var(--paper-red-600, red);
      }

      .require-one-icon:hover,
      .require-one-icon.on {
        color: var(--paper-blue-600, blue);
      }

      .help-dialog {
        --styled-dialog-min-width: 800px;
        --styled-dialog-max-width: 800px;
      }

      .help-text {
        color: var(--primary-text-color);
        font-size: 16px;
        line-height: 18px;
        min-height: 18px;
      }

      .help-text > div {
        margin-left: 15px;
      }
    </style>

    <paper-button class="layout horizontal center open-dialog-button" active="[[opened]]" on-tap="toggleSearchFieldsDialog" title="Click to Enter Search Terms">
      <iron-icon icon="fa:search"></iron-icon>
      <div>Click to Enter Search Terms</div>
    </paper-button>

    <styled-dialog class$="search-dialog [[_isBackdrop(_openedDialogHelp, _openedDialogImages)]]" fill modal opened="{{opened}}">
      <div slot="top" class="layout horizontal center center-justified header">
        <button-action icon="fa:search" text="Search" on-tap="handleSearch"></button-action>
        <button-action icon="fa:undo" text="Reset" on-tap="resetAllSearchFields"></button-action>
        <button-action icon="fa:times" text="Cancel" on-tap="cancelSearch"></button-action>
        <button-action icon="fa:question" text="Help" on-tap="openHelp"></button-action>
        <template is="dom-if" if="[[!hideImages]]">
          <button-action icon="fa:picture-o" text="Images" on-tap="openImages"></button-action>
        </template>
      </div>

      <template is="dom-repeat" items="[[_searchFields]]" as="dialogConfig">
        <div class="layout horizontal">
          <template is="dom-if" if="[[dialogConfig.isDate]]">
            <div class="styled-dialog-name search-name">[[dialogConfig.name]]</div>
            <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
              <div class="layout horizontal date-fields-container nowrap">
                <vaadin-date-picker-display
                  facet-key="value"
                  facets="{{searchConfig}}"
                  key="[[searchConfig.key]]"
                  category="[[searchConfig.title]]">
                </vaadin-date-picker-display>
              </div>
            </template>
          </template>

          <template is="dom-if" if="[[!dialogConfig.isDate]]">
            <template is="dom-if" if="[[dialogConfig.isImage]]">
              <div class="styled-dialog-name images-name">[[dialogConfig.name]]</div>
              <div class="layout vertical flex">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <template is="dom-if" if="[[!searchConfig.images.length]]">
                    <div class="styled-dialog-name no-images">None</div>
                  </template>

                  <search-image-gallery
                    large-image-style-class="[[largeImageStyleClass]]"
                    small-image-style-class="[[smallImageStyleClass]]"
                    excluded="{{searchConfig.excluded}}"
                    images="{{searchConfig.images}}"
                    required="{{searchConfig.required}}"
                    selected="{{searchConfig.selected}}"
                    union="{{searchConfig.union}}">
                  </search-image-gallery>
                </template>
              </div>
            </template>

            <template is="dom-if" if="[[!dialogConfig.isImage]]">
              <div class="styled-dialog-name search-name">[[dialogConfig.name]]</div>
              <div class="layout horizontal wrap">
                <template is="dom-repeat" items="[[dialogConfig.data]]" as="searchConfig">
                  <div class="layout horizontal nowrap search-data">
                    <paper-input
                      class$="[[_getInputWidthStyleClass(searchConfig.enableNetworkExpansion)]]"
                      id$="input_[[searchConfig.key]]"
                      label="[[searchConfig.title]]"
                      value="{{searchConfig.value}}"
                      on-keyup="_didUserHitEnterKey">
                    </paper-input>

                    <div class="layout horizontal">
                      <template is="dom-if" if="[[searchConfig.enableNetworkExpansion]]">
                        <paper-icon-button
                          class$="network-expansion-icon [[_getNetworkExpansionStyleClass(searchConfig.activateNetworkExpansion, _isNetworkExpansionViable)]]"
                          icon="fa:arrows-alt"
                          title="Toggle Network Expansion of [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.activateNetworkExpansion)]])"
                          on-tap="_toggleNetworkExpansion">
                        </paper-icon-button>
                      </template>

                      <paper-icon-button
                        class$="require-one-icon [[_getButtonStyleClass(searchConfig.requireOne)]]"
                        icon="fa:asterisk"
                        title="Require at Least One Term from [[searchConfig.title]] (Currently [[_getButtonText(searchConfig.requireOne)]])"
                        on-tap="_toggleRequireOne">
                      </paper-icon-button>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </template>
        </div>
      </template>

      <template is="dom-if" if="[[!hideImages]]">
        <div slot="bottom" class="footer">
          <div class="layout horizontal link-data">
            <paper-input
              no-label-float
              placeholder="Enter or Paste Image Links"
              value="{{_linksInput}}"
              on-keyup="_didUserHitEnterKeyOnLinksInput">
            </paper-input>

            <paper-icon-button
              class="on"
              icon="fa:plus-circle"
              title="Add Image Links"
              disabled="[[!_linksInput]]"
              on-tap="_handleLinksInput">
            </paper-icon-button>
          </div>

          <vaadin-upload
            accept="image/*"
            files="{{_uploadedFiles}}"
            method="POST"
            target="[[imageUploadUrl]]"
            on-upload-success="_handleImageFileUploadSuccess">
          </vaadin-upload>
        </div>
      </template>
    </styled-dialog>

    <styled-dialog class="help-dialog" header="Search Help" opened="{{_openedDialogHelp}}">
      <div class="help-text">
        Enter words or phrases as <strong>search terms</strong> in one or more text fields.
        Use <strong>commas</strong> to separate search terms.
      </div>
      <div class="help-text">
        A phrase of multiple words (without commas) is treated as a <strong>single</strong> search term (no quotation marks needed).
      </div>
      <div class="help-text">
        Use a <strong>plus sign</strong> (<strong>+</strong>) to mark a <strong>required</strong> search term and a
        <strong>minus sign</strong> (<strong>-</strong>) to mark an <strong>excluded</strong> search term.
      </div>
      <div class="help-text">
        Click the <strong>SEARCH</strong> button or press the <strong>ENTER</strong> key to run the search.
        Click the <strong>RESET</strong> button to clear all terms.
      </div>
      <div class="help-text">
        Example:  <strong>+New York, New Jersey, -New Hampshire</strong>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="require-one-icon on" icon="fa:asterisk"></iron-icon>
        <div>
          Click the <strong>asterisk</strong> button to activate a <strong>required grouping</strong> on all the search terms of a field.
          Search results must match <strong>at least one term from all required groupings</strong>.
          Terms marked as required (+) or excluded (-) are not included in the required grouping.
          This is helpful if you don't need to match multiple search terms simultaneously.
          For example, to find matches for any of the suburbs of New York City, you can activate a required grouping on the
          <strong>City</strong> field with the search terms <strong>New York, Bronx, Brooklyn, Manhattan, Queens</strong>.
        </div>
      </div>

      <div class="styled-dialog-divider"></div>

      <div class="help-text layout horizontal center">
        <iron-icon class="network-expansion-icon on" icon="fa:arrows-alt"></iron-icon>
        <div class="layout vertical">
          <div>
            Click the <strong>expand</strong> button to activate <strong>network expansion</strong> on a field and run a <strong>multi-stage search</strong>:
            first, DIG finds results that match the search terms like normal;
            next, DIG finds results that match the terms in the network expansion fields from the results of the first search;
            then, DIG shows the combined results.
          </div>
          <div style="margin-top: 10px;">
            Network expansion will only work if one or more network expansion fields have one or more search terms.
            Please note that it may take a minute or more to run a search with network expansion activated.
          </div>
        </div>
      </div>
    </styled-dialog>

    <styled-dialog class="images-dialog" fill opened="{{_openedDialogImages}}">
      <div slot="top" class="layout horizontal center">
        <div class="flex styled-dialog-bold styled-dialog-tall">Your Image Links and Uploaded Image Files</div>
        <paper-icon-button icon="fa:times" dialog-confirm title="Close"></paper-icon-button>
      </div>

      <div slot="top" class="styled-dialog-text">Click the check icon next to an image to see the image matches from the DIG data.</div>

      <image-gallery
        slot="top"
        class="input-gallery"
        large-image-style-class="[[largeImageStyleClass]]"
        show-delete
        show-labels
        show-select
        small-image-style-class="[[smallImageStyleClass]]"
        image-name-property="id"
        images="{{images}}"
        processing="[[imagesProcessing]]"
        selected="{{_imagesSelected}}">
      </image-gallery>

      <div slot="top" class="styled-dialog-note">
        <strong>How does it work?</strong>
        Image matches are found by looking at the features in the image like physical characteristics, hairstyle, dress, environment, and pose.  Better matches are shown first in the gallery.  To learn more, please visit <a href="http://www.ee.columbia.edu/ln/dvmm/memex/" target="_blank">here</a>.
      </div>

      <div slot="top" class="styled-dialog-divider"></div>

      <template is="dom-if" if="[[_imageResults.id]]">
        <div slot="top" class="styled-dialog-bold styled-dialog-tall">[[_imageResults.images.length]] DIG Image Matches</div>

        <div slot="top" class="styled-dialog-text">Click the check icon next to an image match to add it to your search.</div>

        <auto-paginated-image-gallery
          class="results-gallery"
          large-image-style-class="[[largeImageStyleClass]]"
          new-tab
          page-size="100"
          show-delete
          show-delete-following
          show-labels
          show-select
          show-select-preceding
          small-image-style-class="[[smallImageStyleClass]]"
          images="{{_imageResults.images}}"
          selected="{{_imageResults.selected}}">
        </auto-paginated-image-gallery>
      </template>

      <div slot="bottom" class="footer">
        <div class="layout horizontal link-data">
          <paper-input
            no-label-float
            placeholder="Enter or Paste Image Links"
            value="{{_linksInput}}"
            on-keyup="_didUserHitEnterKeyOnLinksInput">
          </paper-input>

          <paper-icon-button
            class="on"
            icon="fa:plus-circle"
            title="Add Image Links"
            disabled="[[!_linksInput]]"
            on-tap="_handleLinksInput">
          </paper-icon-button>
        </div>

        <vaadin-upload
          accept="image/*"
          files="{{_uploadedFiles}}"
          method="POST"
          target="[[imageUploadUrl]]"
          on-upload-success="_handleImageFileUploadSuccess">
        </vaadin-upload>
      </div>
    </styled-dialog>
  </template>

  <script>
  (function() {
    /* globals _ */
    'use strict';

    Polymer({
      is: 'search-fields-dialog',

      properties: {
        /**
         * (Optional)
         *
         * A function that returns whether all the search parameters in the given object are disabled (or empty).
         *
         * @type {Object}
         * @default function
         */
        areSearchParametersDisabled: {
          type: Object,
          value: function() {
            return function(searchParameters) {
              return _.keys(searchParameters).every(function(type) {
                if(_.isEmpty(searchParameters[type])) {
                  return true;
                }
                return _.keys(searchParameters[type]).every(function(term) {
                  return !searchParameters[type][term].enabled;
                });
              });
            };
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms search parameter data into a search parameter object.
         *
         * @type {Object}
         * @default function(category, enabled, key, text, search, date) { return { category: category, date: date, enabled: enabled, key: key, search: search, text: text }; }
         */
        buildSearchParameter: {
          type: Object,
          value: function() {
            return function(category, enabled, key, text, search, date) {
              return {
                category: category,
                date: date,
                enabled: enabled,
                key: key,
                search: search,
                text: text
              };
            };
          }
        },

        /**
         * (Optional)
         *
         * The data property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'data'
         */
        dataProperty: {
          type: String,
          value: 'data'
        },

        /**
         * (Optional)
         *
         * The key property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'key'
         */
        dataKeyProperty: {
          type: String,
          value: 'key'
        },

        /**
         * (Optional)
         *
         * The title property in the data in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'title'
         */
        dataTitleProperty: {
          type: String,
          value: 'title'
        },

        /**
         * (Optional)
         *
         * The keys of dates in the searchFieldsConfig mapped to the keys of dates in the searchParameters.
         *
         * @type {Object}
         * @default {}
         */
        dateConfig: {
          type: Object,
          value: function() {
            return {};
          }
        },

        /**
         * (Optional)
         *
         * A function that transforms a search parameter object into an object with "enabled", "search", and "text" properties.
         *
         * @type {Object}
         * @default function(searchParameter) { return { enabled: searchParameter.enabled, search: searchParameter.search, text: searchParameter.text }; }
         */
        getSearchParameterData: {
          type: Object,
          value: function() {
            return function(searchParameter) {
              return {
                enabled: searchParameter.enabled,
                search: searchParameter.search,
                text: searchParameter.text
              };
            };
          }
        },

        /**
         * (Optional)
         *
         * Whether to hide the image button and upload elements.
         *
         * @type {Boolean}
         * @default false
         */
        hideImages: {
          type: Boolean,
          value: false
        },

        /**
         * (Output)
         *
         * The list of image objects (links and/or file data) added and/or uploaded by the user.
         *
         * @type {Array}
         * @default []
         */
        images: {
          notify: true,
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * (Optional)
         *
         * The list of image IDs corresponding to each ID in `images` that is processing.
         *
         * @type {Array}
         * @default []
         */
        imagesProcessing: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * (Optional)
         *
         * The URL for the image uploads.
         *
         * @type {String}
         * @default '/uploadImage'
         */
        imageUploadUrl: {
          type: String,
          value: '/uploadImage'
        },

        /**
         * (Optional)
         *
         * The prefix for the image URL for image field data.
         *
         * @type {String}
         * @default ''
         */
        imageUrlPrefix: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The suffix for the image URL for image field data.
         *
         * @type {String}
         * @default ''
         */
        imageUrlSuffix: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The style class for any image in a popup.
         *
         * @type {String}
         * @default ''
         */
        largeImageStyleClass: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The name property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'name'
         */
        nameProperty: {
          type: String,
          value: 'name'
        },

        /**
         * (Optional|Output)
         *
         * The network expansion parameters passed in.
         *
         * @type {Object}
         */
        networkExpansionParameters: {
          type: Object,
          notify: true
        },

        /**
         * (Optional|Output)
         *
         * Whether the dialog is opened.
         *
         * @type {Boolean}
         * @default false
         */
        opened: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Optional|Output)
         *
         * Whether to let queries run.
         *
         * @type {Boolean}
         * @default false
         */
        processRequest: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * (Required|Output)
         *
         * A list of objects that correspond to groupings of search fields.
         *
         * @type {Array}
         */
        searchFieldsConfig: {
          type: Array
        },

        /**
         * (Required|Output)
         *
         * The search parameters created from the terms entered into the dialog.
         *
         * @type {Object}
         */
        searchParameters: {
          notify: true,
          type: Object
        },

        /**
         * (Optional)
         *
         * The style class for all the images in the galleries.
         *
         * @type {String}
         * @default ''
         */
        smallImageStyleClass: {
          type: String,
          value: ''
        },

        /**
         * (Optional)
         *
         * The type property in the searchFieldsConfig.
         *
         * @type {String}
         * @default 'type'
         */
        typeProperty: {
          type: String,
          value: 'type'
        },

        /**
         * (Optional|Output)
         *
         * Whether the user canceled the changes.
         *
         * @type {Boolean}
         * @default false
         */
        userCanceled: {
          notify: true,
          type: Boolean,
          value: false
        },

        /**
         * An object containing the list of image results and the list of selected image IDs to be shown in the images dialog.
         *
         * @type {Object}
         * @default {images:[],selected:[]}
         * @private
         */
        _imageResults: {
          type: Object,
          value: function() {
            return {
              images: [],
              selected: []
            };
          }
        },

        /**
         * The list of image IDs corresponding to each ID in `images` that is selected.
         *
         * @type {Array}
         * @default []
         * @private
         */
        _imagesSelected: {
          type: Array,
          value: function() {
            return [];
          }
        },

        /**
         * Whether network expansion is viable based on the fields and values.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _isNetworkExpansionViable: {
          type: Boolean,
          value: false
        },

        /**
         * The image links entered by the user.
         *
         * @type {String}
         * @default ''
         * @private
         */
        _linksInput: {
          type: String,
          value: ''
        },

        /**
         * Whether the help dialog is opened.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _openedDialogHelp: {
          type: Boolean,
          value: false
        },

        /**
         * Whether the images dialog is opened.
         *
         * @type {Boolean}
         * @default false
         * @private
         */
        _openedDialogImages: {
          type: Boolean,
          value: false
        },

        /**
         * The search fields shown in the dialog.
         *
         * @type {Array}
         * @private
         */
        _searchFields: {
          computed: '_createSearchFields(searchFieldsConfig, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty)',
          type: Array
        },

        /**
         * The list of uploaded files.
         *
         * @type {Array}
         * @private
         */
        _uploadedFiles: {
          type: Array
        }
      },

      observers: [
        '_handleImagesSelected(_imagesSelected)',
        '_handleImageResultsModified(_imageResults.id, _imageResults.images)',
        '_handleImageResultsSelected(_imageResults.selected)',
        'toggleProcessRequest(searchParameters.*, opened)'
      ],

      /**
       * Creates and returns the search fields shown in the dialog.
       *
       * @param {Array} config
       * @param {String} dataProperty
       * @param {String} nameProperty
       * @param {String} typeProperty
       * @param {String} dataKeyProperty
       * @param {String} dataTitleProperty
       * @return {Array}
       * @private
       */
      _createSearchFields: function(config, dataProperty, nameProperty, typeProperty, dataKeyProperty, dataTitleProperty) {
        var self = this;
        return (config || []).map(function(dialogConfig) {
          var isDate = dialogConfig[typeProperty] === 'date';
          var isImage = dialogConfig[typeProperty] === 'image';
          return {
            data: dialogConfig[dataProperty].map(function(searchConfig) {
              var item = {
                key: searchConfig[dataKeyProperty],
                title: searchConfig[dataTitleProperty]
              };

              if(!isImage) {
                item.value = isDate ? {} : '';
              }

              if(!isImage && !isDate) {
                item.activateNetworkExpansion = false;
                item.activateNetworkExpansionPrevious = false;
                item.enableNetworkExpansion = (searchConfig.enableNetworkExpansion || false);
                item.requireOne = true;
                item.requireOnePrevious = true;
              }

              if(isImage) {
                item.excluded = [];
                item.images = [];
                item.required = [];
                item.selected = [];
                item.union = [];
              }

              return item;
            }),
            isDate: isDate,
            isImage: isImage,
            name: dialogConfig[nameProperty]
          };
        });
      },

      /**
       * Updates the searchParameters using the search fields and closes the dialog if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _didUserHitEnterKey: function(event) {
        this._updateNetworkExpansion();
        if(event.keyCode === 13) {
          this.handleSearch();
        }
      },

      /**
       * Updates the images using the links input if ENTER was pressed.
       *
       * @param {Object} event
       * @private
       */
      _didUserHitEnterKeyOnLinksInput: function(event) {
        if(event.keyCode === 13) {
          this._handleLinksInput();
        }
      },

      /**
       * Returns the style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonStyleClass: function(on) {
        return on ? 'on' : '';
      },

      /**
       * Returns the text for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @return {String}
       * @private
       */
      _getButtonText: function(on) {
        return on ? 'On' : 'Off';
      },

      /**
       * Returns the style class of an input element.
       *
       * @param {Boolean} enableNetworkExpansion
       * @return {String}
       * @private
       */
      _getInputWidthStyleClass: function(enableNetworkExpansion) {
        return enableNetworkExpansion ? '' : 'add-width';
      },

      /**
       * Returns the network expansion style class for the button with the given toggle status.
       *
       * @param {Boolean} on
       * @param {Boolean} active
       * @return {String}
       * @private
       */
      _getNetworkExpansionStyleClass: function(on, active) {
        return this._getButtonStyleClass(on) + (active ? '' : ' inactive');
      },

      /**
       * Adds the uploaded file in the given upload response event object to the global list of images and opens the images dialog.
       *
       * @event upload-success
       * @param {Event} event
       * @private
       */
      _handleImageFileUploadSuccess: function(event) {
        if(event.detail && event.detail.xhr && event.detail.xhr.response) {
          var response = JSON.parse(event.detail.xhr.response);
          if(response.mimeType.indexOf('image') !== 0) {
            return;
          }

          // Use the map function to create a new array.
          this.set('images', this.images.map(function(object) {
            return object;
          }).concat({
            id: event.detail.file.name,
            source: 'data:' + response.mimeType + ';base64,' + response.base64,
            type: 'DATA'
          }));

          this.set('_openedDialogImages', true);
        }
      },

      /**
       * Sets the _imageResults using the given selected image ID and the hits in the global list of images corresponding to the given ID.
       *
       * @param {Array} selectedImageIds
       * @private
       */
      _handleImagesSelected: function(selectedImageIds) {
        if(!selectedImageIds.length) {
          this.set('_imageResults', {
            images: [],
            selected: []
          });
          return;
        }

        if(selectedImageIds.length > 1) {
          // Use the map function to create a new array.
          this.set('_imagesSelected', selectedImageIds.slice(selectedImageIds.length - 1).map(function(id) {
            return id;
          }));
          return;
        }

        var imageId = selectedImageIds[0];
        var imageIndex = _.findIndex(this.images.map(function(object) {
          return object.id;
        }), function(id) {
          return id === imageId;
        });

        if(imageIndex >= 0) {
          this.set('_imageResults', {
            id: imageId,
            images: this.images[imageIndex].hits || [],
            selected: []
          });
        }
      },

      /**
       * Sets the hits in the global list of images corresponding to the given ID to the given list.
       *
       * @param {Number|String} id
       * @param {Array} modifiedImages
       * @private
       */
      _handleImageResultsModified: function(id, modifiedImages) {
        var self = this;
        this.images.forEach(function(image, imageIndex) {
          if(image.id === id && image.hits.length !== modifiedImages.length) {
            self.set(['images', imageIndex, 'hits'], modifiedImages);
          }
        });
      },

      /**
       * Adds the images from the _imageResults using the given list of select image IDs to the selected images in the search fields.
       *
       * @param {Array} selectedImageIds
       * @private
       */
      _handleImageResultsSelected: function(selectedImageIds) {
        if(!selectedImageIds.length) {
          return;
        }

        var self = this;
        this._searchFields.forEach(function(dialogConfig, dialogIndex) {
          if(dialogConfig.isImage) {
            dialogConfig.data.forEach(function(searchConfig, searchIndex) {
              var imageIdsFromConfig = searchConfig.images.map(function(object) {
                return object.id;
              });

              var imageIdsNeededInConfig = selectedImageIds.filter(function(id) {
                return imageIdsFromConfig.indexOf(id) < 0;
              });

              var imagesNeededInConfig = self._imageResults.images.filter(function(object) {
                return imageIdsNeededInConfig.indexOf(object.id) >= 0;
              });

              if(imagesNeededInConfig.length) {
                // Use the map function to create a new array.
                self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'images'], searchConfig.images.map(function(object) {
                  return object;
                }).concat(imagesNeededInConfig));
              }

              var imageIdsToSelectInConfig = selectedImageIds.filter(function(id) {
                return searchConfig.selected.indexOf(id) < 0;
              });

              if(imageIdsToSelectInConfig.length) {
                // Use the map function to create a new array.
                self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'selected'], searchConfig.selected.map(function(id) {
                  return id;
                }).concat(imageIdsToSelectInConfig));
              }
            });
          }
        });
      },

      /**
       * Adds the link(s) in the _linksInput (if non-empty) to the global list of images and opens the images dialog.
       *
       * @private
       */
      _handleLinksInput: function() {
        var links = this._linksInput.replace(/\s/g, ' ').split(' ').filter(function(link) {
          return !!link;
        });

        if(!links.length) {
          return;
        }

        // Use the map function to create a new array.
        this.set('images', this.images.map(function(object) {
          return object;
        }).concat(links.map(function(link) {
          return {
            id: link,
            source: link,
            type: 'LINK'
          };
        })));

        this.set('_linksInput', '');
        this.set('_openedDialogImages', true);
      },

      /**
       * Returns the backdrop style class.
       *
       * @param {Boolean} helpDialogOpened
       * @param {Boolean} imagesDialogOpened
       * @return {String}
       * @private
       */
      _isBackdrop: function(helpDialogOpened, imagesDialogOpened) {
        return helpDialogOpened || imagesDialogOpened ? 'backdrop' : '';
      },

      /**
       * Toggles the activateNetworkExpansion property of the searchConfig in the model of the given event.
       *
       * @event tap
       * @private
       */
      _toggleNetworkExpansion: function(event) {
        event.model.set('searchConfig.activateNetworkExpansion', !event.model.searchConfig.activateNetworkExpansion);
        this._updateNetworkExpansion();
      },

      /**
       * Toggles the requireOne property of the searchConfig in the model of the given event.
       *
       * @event tap
       * @private
       */
      _toggleRequireOne: function(event) {
        event.model.set('searchConfig.requireOne', !event.model.searchConfig.requireOne);
      },

      /**
       * Returns a string of unformatted phones separated by newlines.
       *
       * @param {String} phone
       * @return {String}
       * @private
       */
      _unformatPhones: function(phone) {
        // Replace all delimiters (whitespace, commas, and, semicolons) with single spaces.
        return phone.replace(/[\s,;]/g, ' ')
          // Remove all non-digit, non-whitespace characters.
          .replace(/[^\d\s]/g, '')
          // Remove extra spaces.
          .replace(/\s+/g, '\n')
          .trim();
      },

      /**
       * Updates the date input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateDateFieldFromParameter: function(searchConfig, updatePath) {
        var parameterKey = this.dateConfig[searchConfig.key];
        searchConfig.value = {};
        if(this.searchParameters[parameterKey][searchConfig.key]) {
          searchConfig.value[searchConfig.key] = this.searchParameters[parameterKey][searchConfig.key];
        }
        this.notifyPath(updatePath.concat('value'), searchConfig.value);
      },

      /**
       * Updates the searchParameters with a new date object and notifies observers.
       *
       * @param {String} key
       * @param {Object} date
       * @param {String} text
       * @param {String} category
       * @param {Boolean} enabled
       * @private
       */
      _updateDateParameterAndNotify: function(key, date, text, category, enabled) {
        var parameterKey = this.dateConfig[key];

        this.searchParameters[parameterKey][key] = this.buildSearchParameter(category, enabled, key, text, 'required', date);

        this.notifyPath(['searchParameters', parameterKey, key], this.searchParameters[parameterKey][key]);
      },

      /**
       * Updates the searchParameters using the given date config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateDateParameterFromField: function(searchConfig) {
        var parameterKey = this.dateConfig[searchConfig.key];
        // TODO Don't assume data structure.
        if(!_.isEmpty(searchConfig.value[searchConfig.key])) {
          var dateObject = searchConfig.value[searchConfig.key];
          this._updateDateParameterAndNotify(dateObject.key, dateObject.date, dateObject.text, dateObject.category, dateObject.enabled);
        } else if(this.searchParameters[parameterKey][searchConfig.key]) {
          this.searchParameters[parameterKey][searchConfig.key] = {};
          this.notifyPath(['searchParameters', parameterKey, searchConfig.key], {});
        }
      },

      /**
       * Updates the image gallery input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateImageGalleryFromParameter: function(searchConfig, updatePath) {
        var self = this;
        var images = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).enabled;
        }).map(function(term) {
          var search = self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).search;
          return {
            id: term,
            search: search || 'optional',
            source: self.imageUrlPrefix + term + self.imageUrlSuffix
          };
        });

        this.set(updatePath.concat('images'), images);
        // Use the map function to create a new array.
        this.set(updatePath.concat('selected'), images.map(function(object) {
          return object.id;
        }));
        this.set(updatePath.concat('union'), images.filter(function(object) {
          return object.search === 'union';
        }).map(function(object) {
          return object.id;
        }));
        this.set(updatePath.concat('required'), images.filter(function(object) {
          return object.search === 'required';
        }).map(function(object) {
          return object.id;
        }));
        this.set(updatePath.concat('excluded'), images.filter(function(object) {
          return object.search === 'excluded';
        }).map(function(object) {
          return object.id;
        }));
      },

      /**
       * Updates the searchParameters using the given search config object by adding or removing selected images.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateImageParameterFromGallery: function(searchConfig) {
        var self = this;
        var searchTermToSearchStatus = searchConfig.images.filter(function(object) {
          return searchConfig.selected.indexOf(object.id) >= 0;
        }).reduce(function(searchTermToSearchStatus, selected) {
          if(searchConfig.union.indexOf(selected.id) >= 0) {
            searchTermToSearchStatus[selected.id] = 'union';
          } else if(searchConfig.required.indexOf(selected.id) >= 0) {
            searchTermToSearchStatus[selected.id] = 'required';
          } else if(searchConfig.excluded.indexOf(selected.id) >= 0) {
            searchTermToSearchStatus[selected.id] = 'excluded';
          } else {
            searchTermToSearchStatus[selected.id] = 'optional';
          }
          return searchTermToSearchStatus;
        }, {});

        this._updateSearchParameterTerms(searchConfig, searchTermToSearchStatus);
      },

      /**
       * Updates whether network expansion is active based on the active network expansion fields and values in network expansion fields.
       *
       * @private
       */
      _updateNetworkExpansion: function() {
        // Find all fields for which network expansion is active.
        var fields = this._searchFields.reduce(function(fields, dialogConfig) {
          return fields.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.activateNetworkExpansion;
          }).map(function(searchConfig) {
            return searchConfig.title;
          }));
        }, []);

        // Find all values (search terms) in fields with the network expansion option.
        var values = this._searchFields.reduce(function(values, dialogConfig) {
          return values.concat(dialogConfig.data.filter(function(searchConfig) {
            return searchConfig.enableNetworkExpansion && !!(searchConfig.value.trim());
          }).map(function(searchConfig) {
            return searchConfig.value.trim();
          }));
        }, []).reduce(function(values, value) {
          // Split values into individual search terms.
          return values.concat(value.split(',').map(function(term) {
            return term.trim();
          }).filter(function(term) {
            return term && term !== '+' && term !== '-';
          }));
        }, []);

        this._isNetworkExpansionViable = (fields.length && values.length);
      },

      /**
       * Updates the search field input of the given config object using the searchParameters and notifies observers on the given path.
       *
       * @param {Object} searchConfig
       * @param {Array|String} updatePath
       * @private
       */
      _updateSearchFieldFromParameter: function(searchConfig, updatePath) {
        var self = this;
        var termData = _.keys(this.searchParameters[searchConfig.key]).filter(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]).enabled;
        }).map(function(term) {
          return self.getSearchParameterData(self.searchParameters[searchConfig.key][term]);
        });

        searchConfig.value = termData.map(function(data) {
          var prefix = (data.search === 'required' ? '+' : (data.search === 'excluded' ? '-' : ''));
          return prefix + data.text;
        }).join(', ');
        this.$$('#input_' + searchConfig.key).value = searchConfig.value;

        searchConfig.activateNetworkExpansion = this.networkExpansionParameters[searchConfig.key] || searchConfig.activateNetworkExpansion;
        this.notifyPath(updatePath.concat(['activateNetworkExpansion']), searchConfig.activateNetworkExpansion);

        searchConfig.requireOne = !termData.length ? searchConfig.requireOne : termData.some(function(data) {
          return data.search === 'union';
        });
        this.notifyPath(updatePath.concat(['requireOne']), searchConfig.requireOne);
      },

      /**
       * Updates the searchParameters with a new object and notifies observers.
       *
       * @param {String} type
       * @param {String} term
       * @param {String} title
       * @param {Boolean} enabled
       * @private
       */
      _updateSearchParameterAndNotify: function(type, term, name, enabled, search) {
        this.searchParameters[type][term] = this.buildSearchParameter(name, enabled, term, term, search);

        this.notifyPath(['searchParameters', type, '*'], this.searchParameters[type][term]);
      },

      /**
       * Updates the searchParameters and networkExpansionParameters using the given config object by adding or removing search terms.
       *
       * @param {Object} searchConfig
       * @private
       */
      _updateSearchParameterFromField: function(searchConfig) {
        var self = this;

        var searchTermToSearchStatus = searchConfig.value.split(',').map(function(term) {
          return term.trim();
        }).reduce(function(searchTermToSearchStatus, term) {
          var search = searchConfig.requireOne ? 'union' : 'optional';
          var key = term;

          // A required or excluded term overrides searchConfig.requireOne.
          if(key.indexOf('+') === 0 || key.indexOf('-') === 0) {
            search = key.indexOf('+') === 0 ? 'required' : 'excluded';
            key = key.substring(1);
          }

          // TODO Move custom formatting.
          if(searchConfig.key === 'phone') {
            key = self._unformatPhones(key);
          }

          if(key) {
            searchTermToSearchStatus[key] = search;
          }

          return searchTermToSearchStatus;
        }, {});

        this._updateSearchParameterTerms(searchConfig, searchTermToSearchStatus);

        var activateNetworkExpansion = !!(this._isNetworkExpansionViable && searchConfig.activateNetworkExpansion);

        if(this.networkExpansionParameters[searchConfig.key] !== activateNetworkExpansion) {
          this.networkExpansionParameters[searchConfig.key] = activateNetworkExpansion;
          this.notifyPath(['networkExpansionParameters', searchConfig.key], this.networkExpansionParameters[searchConfig.key]);
        }
      },

      /**
       * Updates the searchParameters using the search fields in the dialog by adding or removing search terms.
       *
       * @private
       */
      _updateSearchParametersFromFields: function() {
        var self = this;

        if(this._searchFields) {
          this._searchFields.forEach(function(dialogConfig) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig) {
                if(dialogConfig.isDate) {
                  self._updateDateParameterFromField(searchConfig);
                } else if(dialogConfig.isImage) {
                  self._updateImageParameterFromGallery(searchConfig);
                } else {
                  self._updateSearchParameterFromField(searchConfig);
                }
              });
            }
          });
        }
      },

      /**
       * Updates the searchParameters for the given searchConfig using the given search terms.
       *
       * @param {Object} searchConfig
       * @param {Object} searchTermToSearchStatus
       * @private
       */
      _updateSearchParameterTerms: function(searchConfig, searchTermToSearchStatus) {
        var self = this;

        _.keys(self.searchParameters[searchConfig.key]).forEach(function(term) {
          // Disable deleted terms.
          if(self.searchParameters[searchConfig.key][term].enabled && _.keys(searchTermToSearchStatus).indexOf(term) < 0) {
            self.searchParameters[searchConfig.key][term] = self.buildSearchParameter(searchConfig.title, false, term, term);
          }
        });

        _.keys(searchTermToSearchStatus).forEach(function(term) {
          // Add new terms.
          if(term) {
            self.searchParameters[searchConfig.key][term] = self.buildSearchParameter(searchConfig.title, true, term, term, searchTermToSearchStatus[term]);
          }
        });

        this.notifyPath(['searchParameters', searchConfig.key], this.searchParameters[searchConfig.key]);
      },

      /**
       * Cancels the changes to the search fields and closes the dialog.
       */
      cancelSearch: function() {
        this._uploadedFiles = [];
        this._searchFields.forEach(function(dialogConfig) {
          dialogConfig.data.forEach(function(searchConfig) {
            searchConfig.activateNetworkExpansion = searchConfig.activateNetworkExpansionPrevious;
            searchConfig.requireOne = searchConfig.requireOnePrevious;
          });
        });

        this.userCanceled = true;
        this.toggleSearchFieldsDialog();
      },

      /**
       * Updates the searchParameters using the search fields and closes the dialog so that new queries can run.
       */
      handleSearch: function() {
        this._uploadedFiles = [];
        this._searchFields.forEach(function(dialogConfig) {
          dialogConfig.data.forEach(function(searchConfig) {
            searchConfig.activateNetworkExpansionPrevious = searchConfig.activateNetworkExpansion;
            searchConfig.requireOnePrevious = searchConfig.requireOne;
          });
        });

        this._updateSearchParametersFromFields();

        if(this.areSearchParametersDisabled(this.searchParameters)) {
          this.resetAllSearchFields();
          return;
        }

        this.toggleSearchFieldsDialog();
      },

      /**
       * Opens the help dialog.
       */
      openHelp: function() {
        this.set('_openedDialogHelp', true);
      },

      /**
       * Opens the images dialog.
       */
      openImages: function() {
        this.set('_openedDialogImages', true);
      },

      /**
       * Clears all of the search fields in the dialog.
       */
      resetAllSearchFields: function() {
        this._uploadedFiles = [];
        if(this._searchFields) {
          var self = this;
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dialogConfig.isDate) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'value'], {});
                } else if(dialogConfig.isImage) {
                  self.set(['_searchFields', dialogIndex, 'data', searchIndex, 'selected'], []);
                } else {
                  self.$$('#input_' + searchConfig.key).value = '';
                }
              });
            }
          });
        }
      },

      /**
       * Toggles whether to let queries run whenever the search parameters change or the dialog is opened or closed.
       */
      toggleProcessRequest: function() {
        this.processRequest = !this.opened && !this.userCanceled;
        // reset user canceled variable
        this.userCanceled = false;
      },

      /**
       * Updates the search fields shown in the dialog using the search parameters if opening the dialog, then opens or closes the dialog.
       */
      toggleSearchFieldsDialog: function() {
        var self = this;

        // Set or clear the search fields whenever the dialog is opened.
        if(!this.opened && this._searchFields) {
          this._searchFields.forEach(function(dialogConfig, dialogIndex) {
            if(dialogConfig.data) {
              dialogConfig.data.forEach(function(searchConfig, searchIndex) {
                if(dialogConfig.isDate) {
                  self._updateDateFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                } else if(dialogConfig.isImage) {
                  self._updateImageGalleryFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                } else {
                  self._updateSearchFieldFromParameter(searchConfig, ['_searchFields', dialogIndex, 'data', searchIndex]);
                }
              });
            }
          });
          this._updateNetworkExpansion();
        }

        this.opened = !this.opened;
      }
    });
  })();
  </script>
</dom-module>
